<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="picoCTF 2018 - be-quick-or-be-dead-3" property="og:title"><meta content="article" property="og:type"><meta content="2018-10-16T13:53:29.636Z" property="og:published_time"><meta content="2018-10-19T00:42:37.752Z" property="og:modified_time"><meta content="Srikavin Ramkumar" property="og:author" name="author"><meta content="ctf-writeups" property="og:section"><meta content="picoctf18" property="og:tag"><meta content="binary-exploitation" property="og:tag"><meta content="reversing" property="og:tag"><meta content="picoctf18, binary-exploitation, reversing" property="keywords"><meta content="https://blog.srikavin.me/posts/picoctf-2018-be-quick-or-be-dead-3/" property="og:url"><title>picoCTF 2018 - be-quick-or-be-dead-3 - srikavin.me</title><link href="/favicon.png" rel="icon"><link href="/bundle.css" rel="stylesheet"><script src="https://www.googletagmanager.com/gtag/js?id=G-X8ZVFPQ0CK" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-X8ZVFPQ0CK');</script></head><body><nav><div class="nav-left"><span><a href="https://srikavin.me" class="name">Srikavin Ramkumar</a> </span><span><a href="/posts" class="nav-link">Posts</a> </span><span><a href="/tags" class="nav-link">Tags</a></span></div><div class="nav-right"><a href="https://github.com/srikavin"><img alt="Github" height="24px" src="/gh-logo.png" width="24px"></a></div></nav><section class="section"><div class="container"><div class="page-container"><div class="blog-header"><h1 class="title">picoCTF 2018 - be-quick-or-be-dead-3</h1><div class="subtitle"><span>Posted on <span class="date" title="Created: 2018-10-16T13:53:29.636Z&#10;Updated: 2018-10-19T00:42:37.752Z">October 16, 2018* </span>in ctf-writeups</span></div><div class="tags"><a href="https:&#x2F;&#x2F;blog.srikavin.me&#x2F;tags&#x2F;picoctf18&#x2F;"><span class="interactive minimal tag">picoctf18</span></a> <a href="https:&#x2F;&#x2F;blog.srikavin.me&#x2F;tags&#x2F;binary-exploitation&#x2F;"><span class="interactive minimal tag">binary-exploitation</span></a> <a href="https:&#x2F;&#x2F;blog.srikavin.me&#x2F;tags&#x2F;reversing&#x2F;"><span class="interactive minimal tag">reversing</span></a></div></div><div class="blog-content light"><div class="blog-scrollspy"><h1 class="scrollspy-label">Table of Contents</h1><ul><li><a href="#problem" data-target="problem">Problem</a></li><li><a href="#solution" data-target="solution">Solution</a></li></ul></div><h1 id="problem">Problem</h1><blockquote><p>As the <a href="https://www.youtube.com/watch?v=CTt1vk9nM9c">song</a> draws closer to the end, another executable <a href="https://2018shell2.picoctf.com/static/1da7d7f7d74df19b7bdb54a3294dd930/be-quick-or-be-dead-3">be-quick-or-be-dead-3</a> suddenly pops up. This one requires even faster machines. Can you run it fast enough too?</p></blockquote><h1 id="solution">Solution</h1><p>After decompiling the program with <a href="https://derevenets.com/">Snowman</a>, we can see pseudocode for the <code>calc</code> function:</p><pre style="background-color:#ffffff;">
<code><span style="color:#0086b3;">uint32_t </span><span style="font-weight:bold;color:#795da3;">calc</span><span style="color:#323232;">(</span><span style="color:#0086b3;">uint32_t </span><span style="color:#323232;">edi) {
    </span><span style="color:#0086b3;">uint32_t</span><span style="color:#323232;"> eax2;
    </span><span style="color:#0086b3;">uint32_t</span><span style="color:#323232;"> eax3;
    </span><span style="color:#0086b3;">uint32_t</span><span style="color:#323232;"> eax4;
    </span><span style="color:#0086b3;">uint32_t</span><span style="color:#323232;"> eax5;
    </span><span style="color:#0086b3;">uint32_t</span><span style="color:#323232;"> eax6;
    </span><span style="color:#0086b3;">uint32_t</span><span style="color:#323232;"> v7;

    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(edi </span><span style="font-weight:bold;color:#a71d5d;">&gt; </span><span style="color:#0086b3;">4</span><span style="color:#323232;">) {
        eax2 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">calc(edi </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#0086b3;">1</span><span style="color:#323232;">);
        eax3 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">calc(edi </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#0086b3;">2</span><span style="color:#323232;">);
        eax4 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">calc(edi </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#0086b3;">3</span><span style="color:#323232;">);
        eax5 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">calc(edi </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#0086b3;">4</span><span style="color:#323232;">);
        eax6 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">calc(edi </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#0086b3;">5</span><span style="color:#323232;">);
        v7 </span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;"> eax6 </span><span style="font-weight:bold;color:#a71d5d;">* </span><span style="color:#0086b3;">0x1234 </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#323232;">(eax2 </span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;"> eax3 </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#323232;">(eax4 </span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;"> eax5));
    } </span><span style="font-weight:bold;color:#a71d5d;">else </span><span style="color:#323232;">{
        v7 </span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;"> edi </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;"> edi </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#0086b3;">0x2345</span><span style="color:#323232;">;
    }
    </span><span style="font-weight:bold;color:#a71d5d;">return</span><span style="color:#323232;"> v7;
}
</span></code></pre><span id="continue-reading"></span><p>A way to drastically reduce the runtime of a recursive program is to introduce the dynamic programming concept of memoization. It's basically just caching the results of each computation. <a href="https://repl.it/repls/PerfumedBlissfulMouse">Here</a> is a memoized version of the function:</p><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">#include </span><span style="color:#183691;">&lt;stdio.h&gt;
</span><span style="font-weight:bold;color:#a71d5d;">#include </span><span style="color:#183691;">&lt;inttypes.h&gt;

</span><span style="color:#0086b3;">uint32_t</span><span style="color:#323232;"> value[</span><span style="color:#0086b3;">0x18e9f</span><span style="color:#323232;">] ;
</span><span style="font-weight:bold;color:#a71d5d;">int</span><span style="color:#323232;"> exists[</span><span style="color:#0086b3;">0x18e9f</span><span style="color:#323232;">];

</span><span style="color:#0086b3;">uint32_t </span><span style="font-weight:bold;color:#795da3;">calc</span><span style="color:#323232;">(</span><span style="color:#0086b3;">uint32_t </span><span style="color:#323232;">edi) {
    </span><span style="font-style:italic;color:#969896;">//Check if we&#39;ve already done this calculation
    </span><span style="font-weight:bold;color:#a71d5d;">if</span><span style="color:#323232;">(exists[edi]){
    </span><span style="font-style:italic;color:#969896;">//If we have, just return the precomputed value
      </span><span style="font-weight:bold;color:#a71d5d;">return</span><span style="color:#323232;"> value[edi];
    }
    </span><span style="font-style:italic;color:#969896;">//If not, just continue the calculation
    </span><span style="color:#0086b3;">uint32_t</span><span style="color:#323232;"> eax2;
    </span><span style="color:#0086b3;">uint32_t</span><span style="color:#323232;"> eax3;
    </span><span style="color:#0086b3;">uint32_t</span><span style="color:#323232;"> eax4;
    </span><span style="color:#0086b3;">uint32_t</span><span style="color:#323232;"> eax5;
    </span><span style="color:#0086b3;">uint32_t</span><span style="color:#323232;"> eax6;
    </span><span style="color:#0086b3;">uint32_t</span><span style="color:#323232;"> v7;

    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">(edi </span><span style="font-weight:bold;color:#a71d5d;">&gt; </span><span style="color:#0086b3;">4</span><span style="color:#323232;">) {
        eax2 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">calc(edi </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#0086b3;">1</span><span style="color:#323232;">);
        eax3 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">calc(edi </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#0086b3;">2</span><span style="color:#323232;">);
        eax4 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">calc(edi </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#0086b3;">3</span><span style="color:#323232;">);
        eax5 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">calc(edi </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#0086b3;">4</span><span style="color:#323232;">);
        eax6 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">calc(edi </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#0086b3;">5</span><span style="color:#323232;">);
        v7 </span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;"> eax6 </span><span style="font-weight:bold;color:#a71d5d;">* </span><span style="color:#0086b3;">0x1234 </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#323232;">(eax2 </span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;"> eax3 </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#323232;">(eax4 </span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#323232;"> eax5));
    } </span><span style="font-weight:bold;color:#a71d5d;">else </span><span style="color:#323232;">{
        v7 </span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;"> edi </span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;"> edi </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#0086b3;">0x2345</span><span style="color:#323232;">;
    }
    </span><span style="font-style:italic;color:#969896;">//Store the current result into the memo table
</span><span style="color:#323232;">    value[edi] </span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;"> v7;
    exists[edi] </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">1</span><span style="color:#323232;">;
    </span><span style="font-weight:bold;color:#a71d5d;">return</span><span style="color:#323232;"> v7;
}

</span><span style="font-weight:bold;color:#a71d5d;">int </span><span style="font-weight:bold;color:#795da3;">main</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">void</span><span style="color:#323232;">) {
  </span><span style="color:#62a35c;">printf</span><span style="color:#323232;">(</span><span style="color:#183691;">&quot;%&quot;</span><span style="color:#323232;"> PRIu32 </span><span style="color:#183691;">&quot;</span><span style="color:#0086b3;">\n</span><span style="color:#183691;">&quot;</span><span style="color:#323232;">, calc(</span><span style="color:#0086b3;">0x18e9f</span><span style="color:#323232;">));
  </span><span style="font-weight:bold;color:#a71d5d;">return </span><span style="color:#0086b3;">0</span><span style="color:#323232;">;
}
</span></code></pre><p>Running this program gives: <code>3610015907</code>. Now we need to pass this value to <code>print_flag</code>. We can run the program in gdb. Using <code>handle SIGALRM ignore</code>, we can avoid the termination of the program if we take too long. Looking at the assembly, we can see that the calculated key is set to <code>0x6010b0</code>:</p><pre style="background-color:#ffffff;">
<code><span style="color:#323232;">(gdb) disassemble get_key
Dump of assembler code for function get_key:
   0x0000000000400815 &lt;+0&gt;:     push   %rbp
   0x0000000000400816 &lt;+1&gt;:     mov    %rsp,%rbp
   0x0000000000400819 &lt;+4&gt;:     mov    $0x400a08,%edi
   0x000000000040081e &lt;+9&gt;:     callq  0x400530 &lt;puts@plt&gt;
   0x0000000000400823 &lt;+14&gt;:    mov    $0x0,%eax
   0x0000000000400828 &lt;+19&gt;:    callq  0x400792 &lt;calculate_key&gt;
   0x000000000040082d &lt;+24&gt;:    mov    %eax,0x20087d(%rip)        # 0x6010b0 &lt;key&gt;
   0x0000000000400833 &lt;+30&gt;:    mov    $0x400a1b,%edi
   0x0000000000400838 &lt;+35&gt;:    callq  0x400530 &lt;puts@plt&gt;
   0x000000000040083d &lt;+40&gt;:    nop
   0x000000000040083e &lt;+41&gt;:    pop    %rbp
   0x000000000040083f &lt;+42&gt;:    retq
End of assembler dump.
</span></code></pre><p>So, we need to set that address to <code>3610015907</code>:</p><p><code>set {int}0x6010b0=3610015907</code>.</p><p>Now we need to skip the call to <code>calculate_key.</code> To do this, we can set a breakpoint right before the call:</p><p><code>break 0x4008c9</code>, run the program:</p><p><code>run</code>, then when the breakpoint is triggered, jump to the <code>decrypt_flag</code> call:</p><pre style="background-color:#ffffff;">
<code><span style="color:#323232;">(gdb) jump *0x4008d3
Continuing at 0x4008d3.
Printing flag:
picoCTF{dynamic_pr0gramming_ftw_1ffc009d}
[Inferior 1 (process 31) exited normally]
</span></code></pre></div></div><script src="https://utteranc.es/client.js" async crossorigin="anonymous" issue-term="url" label="ðŸ’¬comments" repo="srikavin/blog" theme="github-light"></script></div></section><script src="/bundle.js"></script></body></html>