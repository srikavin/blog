<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="picoCTF 2019 - Java Script Kiddie 2" property="og:title"><meta content="article" property="og:type"><meta content="2019-10-12T22:48:41.356Z" property="og:published_time"><meta content="2019-11-14T04:43:58.202Z" property="og:modified_time"><meta content="Srikavin Ramkumar" property="og:author" name="author"><meta content="ctf-writeups" property="og:section"><meta content="picoctf19" property="og:tag"><meta content="web" property="og:tag"><meta content="reversing" property="og:tag"><meta content="javascript" property="og:tag"><meta content="picoctf19, web, reversing, javascript" property="keywords"><meta content="https://blog.srikavin.me/posts/picoctf-2019-java-script-kiddie-2/" property="og:url"><title>picoCTF 2019 - Java Script Kiddie 2 - srikavin.me</title><link href="/favicon.png" rel="icon"><link href="/bundle.css" rel="stylesheet"><script src="https://www.googletagmanager.com/gtag/js?id=G-X8ZVFPQ0CK" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-X8ZVFPQ0CK');</script></head><body><nav><div class="nav-left"><span><a href="https://srikavin.me" class="name">Srikavin Ramkumar</a> </span><span><a href="/posts" class="nav-link">Posts</a> </span><span><a href="/tags" class="nav-link">Tags</a></span></div><div class="nav-right"><a href="https://github.com/srikavin"><img alt="Github" src="/gh-logo.png" height="24px" width="24px"></a></div></nav><section class="section"><div class="container"><div class="page-container"><div class="blog-header"><h1 class="title">picoCTF 2019 - Java Script Kiddie 2</h1><div class="subtitle"><span>Posted on <span class="date" title="Created: 2019-10-12T22:48:41.356Z&#10;Updated: 2019-11-14T04:43:58.202Z">October 12, 2019* </span>in ctf-writeups</span></div><div class="tags"><a href="https:&#x2F;&#x2F;blog.srikavin.me&#x2F;tags&#x2F;picoctf19&#x2F;"><span class="interactive minimal tag">picoctf19</span></a> <a href="https:&#x2F;&#x2F;blog.srikavin.me&#x2F;tags&#x2F;web&#x2F;"><span class="interactive minimal tag">web</span></a> <a href="https:&#x2F;&#x2F;blog.srikavin.me&#x2F;tags&#x2F;reversing&#x2F;"><span class="interactive minimal tag">reversing</span></a> <a href="https:&#x2F;&#x2F;blog.srikavin.me&#x2F;tags&#x2F;javascript&#x2F;"><span class="interactive minimal tag">javascript</span></a></div></div><div class="blog-content light"><div class="blog-scrollspy"><h1 class="scrollspy-label">Table of Contents</h1><ul></ul></div><p>We are given a website, that is nearly identical to Java Script Kiddie 1. The <code>assemble_png</code> function takes in a key of length 32, and manipulates the bytes to decode the <code>src</code> attribute of an image.</p><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">function </span><span style="font-weight:bold;color:#795da3;">assemble_png</span><span style="color:#323232;">(u_in){
    </span><span style="font-weight:bold;color:#a71d5d;">var </span><span style="color:#0086b3;">LEN </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">16</span><span style="color:#323232;">;
    </span><span style="font-weight:bold;color:#a71d5d;">var </span><span style="color:#323232;">key </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&quot;00000000000000000000000000000000&quot;</span><span style="color:#323232;">;
    </span><span style="font-weight:bold;color:#a71d5d;">var </span><span style="color:#323232;">shifter;
    </span><span style="font-weight:bold;color:#a71d5d;">if</span><span style="color:#323232;">(u_in.length </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#323232;">key.length){
        key </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">u_in;
    }
    </span><span style="font-weight:bold;color:#a71d5d;">var </span><span style="color:#323232;">result </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">[];
    </span><span style="font-weight:bold;color:#a71d5d;">for</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">var </span><span style="color:#323232;">i </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">0</span><span style="color:#323232;">; i </span><span style="font-weight:bold;color:#a71d5d;">&lt; </span><span style="color:#0086b3;">LEN</span><span style="color:#323232;">; i</span><span style="font-weight:bold;color:#a71d5d;">++</span><span style="color:#323232;">){
        shifter </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">Number</span><span style="color:#323232;">(key.slice((i</span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#0086b3;">2</span><span style="color:#323232;">),(i</span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#0086b3;">2</span><span style="color:#323232;">)</span><span style="font-weight:bold;color:#a71d5d;">+</span><span style="color:#0086b3;">1</span><span style="color:#323232;">));
        </span><span style="font-weight:bold;color:#a71d5d;">for</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">var </span><span style="color:#323232;">j </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">0</span><span style="color:#323232;">; j </span><span style="font-weight:bold;color:#a71d5d;">&lt; </span><span style="color:#323232;">(bytes.length </span><span style="font-weight:bold;color:#a71d5d;">/ </span><span style="color:#0086b3;">LEN</span><span style="color:#323232;">); j </span><span style="font-weight:bold;color:#a71d5d;">++</span><span style="color:#323232;">){
            result[(j </span><span style="font-weight:bold;color:#a71d5d;">* </span><span style="color:#0086b3;">LEN</span><span style="color:#323232;">) </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#323232;">i] </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">bytes[(((j </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#323232;">shifter) </span><span style="font-weight:bold;color:#a71d5d;">* </span><span style="color:#0086b3;">LEN</span><span style="color:#323232;">) </span><span style="font-weight:bold;color:#a71d5d;">% </span><span style="color:#323232;">bytes.length) </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#323232;">i]
        }
    }
    </span><span style="font-weight:bold;color:#a71d5d;">while</span><span style="color:#323232;">(result[result.length</span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#0086b3;">1</span><span style="color:#323232;">] </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#0086b3;">0</span><span style="color:#323232;">){
        result </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">result.slice(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">,result.length</span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#0086b3;">1</span><span style="color:#323232;">);
    }
    </span><span style="color:#0086b3;">document</span><span style="color:#323232;">.getElementById(</span><span style="color:#183691;">&quot;Area&quot;</span><span style="color:#323232;">).src </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&quot;data:image/png;base64,&quot; </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#323232;">btoa(</span><span style="color:#0086b3;">String</span><span style="color:#323232;">.</span><span style="color:#0086b3;">fromCharCode</span><span style="color:#323232;">.apply(</span><span style="color:#0086b3;">null</span><span style="color:#323232;">, </span><span style="font-weight:bold;color:#a71d5d;">new </span><span style="color:#0086b3;">Uint8Array</span><span style="color:#323232;">(result)));
    </span><span style="font-weight:bold;color:#a71d5d;">return </span><span style="color:#0086b3;">false</span><span style="color:#323232;">;
}
</span></code></pre><span id="continue-reading"></span><p>Based on testing, the <code>document.getElementById(&quot;Area&quot;).src</code> will only change by 1 or 2 characters based on the input key, and it only affects the output in matching positions. That is, a key starting with <code>5871</code> will always start with <code>data:image/png;base64,iV</code>. Base64 encoded pngs always start with the following header <code>data:image/png;base64,iVBORw0KGgoAAAANSUhEU</code>. Therefore, we can easily bruteforce this. I used the following script (by pasting into Chrome DevTools Console). However, because this script only expects a change in <code>src</code> by a single character for every two input digits, this occasionally requires manual intervention by updating <code>cur_known</code> and <code>cur_expected</code>, preventing a raw bruteforce.</p><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">const </span><span style="color:#323232;">expected_final </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&#39;data:image/png;base64,iVBORw0KGgoAAAANSUhEU&#39;

</span><span style="font-style:italic;color:#969896;">//let cur_known = &#39;&#39;
//let cur_expected = &#39;data:image/png;base64,i&#39;

//let cur_known = &#39;50706000107050002115&#39;
//let cur_expected = &#39;data:image/png;base64,iVBORw0KGgoA&#39;

//let cur_known = &#39;507060001070500060100090&#39;
//let cur_expected = &#39;data:image/png;base64,iVBORw0KGgoAAAANS&#39;

</span><span style="font-weight:bold;color:#a71d5d;">let </span><span style="color:#323232;">cur_known </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&#39;507060001070500060100090300706&#39;
</span><span style="font-weight:bold;color:#a71d5d;">let </span><span style="color:#323232;">cur_expected </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&#39;data:image/png;base64,iVBORw0KGgoAAAANSUhEU&#39;

</span><span style="color:#323232;">ignored </span><span style="font-weight:bold;color:#a71d5d;">= new </span><span style="color:#0086b3;">Set</span><span style="color:#323232;">()

</span><span style="font-weight:bold;color:#a71d5d;">while </span><span style="color:#323232;">(cur_known.length </span><span style="font-weight:bold;color:#a71d5d;">&lt;= </span><span style="color:#0086b3;">32</span><span style="color:#323232;">){
	</span><span style="font-weight:bold;color:#a71d5d;">let </span><span style="color:#323232;">found </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">false</span><span style="color:#323232;">;
	</span><span style="color:#795da3;">console</span><span style="color:#323232;">.</span><span style="color:#0086b3;">log</span><span style="color:#323232;">(cur_known)
	
	</span><span style="font-weight:bold;color:#a71d5d;">let </span><span style="color:#323232;">cur;
	
	outer:
	</span><span style="font-weight:bold;color:#a71d5d;">for</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">let </span><span style="color:#323232;">j </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">0</span><span style="color:#323232;">; j </span><span style="font-weight:bold;color:#a71d5d;">&lt; </span><span style="color:#0086b3;">10</span><span style="color:#323232;">; j</span><span style="font-weight:bold;color:#a71d5d;">++</span><span style="color:#323232;">) {
		</span><span style="font-weight:bold;color:#a71d5d;">for</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">let </span><span style="color:#323232;">i </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">0</span><span style="color:#323232;">; i </span><span style="font-weight:bold;color:#a71d5d;">&lt; </span><span style="color:#0086b3;">10</span><span style="color:#323232;">; i</span><span style="font-weight:bold;color:#a71d5d;">++</span><span style="color:#323232;">) {
			cur </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">cur_known </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#323232;">j </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#323232;">i;
			
			</span><span style="font-weight:bold;color:#a71d5d;">if</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">!</span><span style="color:#323232;">ignored.has(cur)){
				assemble_png(cur.padEnd(</span><span style="color:#0086b3;">32</span><span style="color:#323232;">, </span><span style="color:#183691;">&#39;0&#39;</span><span style="color:#323232;">)); 
				
				</span><span style="font-weight:bold;color:#a71d5d;">if</span><span style="color:#323232;">(</span><span style="color:#0086b3;">document</span><span style="color:#323232;">.getElementById(</span><span style="color:#183691;">&quot;Area&quot;</span><span style="color:#323232;">).src.startsWith(cur_expected)) {
					found </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">true</span><span style="color:#323232;">;
					</span><span style="font-weight:bold;color:#a71d5d;">break </span><span style="color:#323232;">outer;
				}
			}
		}
	}
	
	</span><span style="font-weight:bold;color:#a71d5d;">if</span><span style="color:#323232;">(</span><span style="font-weight:bold;color:#a71d5d;">!</span><span style="color:#323232;">found){
		</span><span style="color:#795da3;">console</span><span style="color:#323232;">.</span><span style="color:#0086b3;">log</span><span style="color:#323232;">(</span><span style="color:#183691;">&#39;Backtracking&#39;</span><span style="color:#323232;">, cur_known, </span><span style="color:#0086b3;">document</span><span style="color:#323232;">.getElementById(</span><span style="color:#183691;">&quot;Area&quot;</span><span style="color:#323232;">).src, cur_expected)
		</span><span style="font-style:italic;color:#969896;">// Ignore current string
		</span><span style="color:#323232;">ignored.add(cur_known)
		</span><span style="color:#795da3;">console</span><span style="color:#323232;">.</span><span style="color:#0086b3;">log</span><span style="color:#323232;">(ignored)
		
		</span><span style="font-style:italic;color:#969896;">// Backtrack - last one was wrong
		</span><span style="color:#323232;">cur_known </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">cur_known.substring(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">, cur_known.length </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#0086b3;">2</span><span style="color:#323232;">);

		cur_expected </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">cur_expected.substring(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">, cur_expected.length </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#0086b3;">1</span><span style="color:#323232;">);
	}
	
	</span><span style="font-weight:bold;color:#a71d5d;">if</span><span style="color:#323232;">(found){
		</span><span style="font-weight:bold;color:#a71d5d;">if</span><span style="color:#323232;">(cur_expected </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#323232;">expected_final){
			alert(</span><span style="color:#183691;">&#39;Found&#39;</span><span style="color:#323232;">)
			</span><span style="font-weight:bold;color:#a71d5d;">break</span><span style="color:#323232;">;
		}
		</span><span style="color:#795da3;">console</span><span style="color:#323232;">.</span><span style="color:#0086b3;">log</span><span style="color:#323232;">(</span><span style="color:#183691;">&#39;Found&#39;</span><span style="color:#323232;">, cur, </span><span style="color:#0086b3;">document</span><span style="color:#323232;">.getElementById(</span><span style="color:#183691;">&quot;Area&quot;</span><span style="color:#323232;">).src, cur_expected)
		cur_known </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">cur;
		
		cur_expected </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">expected_final.substr(</span><span style="color:#0086b3;">0</span><span style="color:#323232;">, cur_expected.length </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#0086b3;">1</span><span style="color:#323232;">);
	}
}
</span></code></pre><p>After running this script, we are able to see the decoded image:</p><p><img alt="" src="https://blog.srikavin.me/posts/picoctf-2019-java-script-kiddie-2/5da2582c0ac7cd093dc392d5.png"></p><p>Decoding the QR code gives us the flag:</p><pre style="background-color:#ffffff;">
<code><span style="color:#323232;">picoCTF{b19be0d3b70ffc63b6367ecf136e853e}
</span></code></pre></div></div><script src="https://utteranc.es/client.js" async crossorigin="anonymous" issue-term="url" label="💬comments" repo="srikavin/blog" theme="github-light"></script></div></section><script src="/bundle.js"></script></body></html>